<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Monitor | Global Betting Intelligence Platform</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --border-primary: #30363d;
            --border-highlight: #388bfd;
            
            --accent-cyan: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-orange: #db6d28;
            --accent-purple: #a371f7;
            
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            max-width: 2000px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logo-text {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .logo-tag {
            font-size: 0.65rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .nav-link:hover { color: var(--text-primary); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .live-clock {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-red);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.5rem 1.5rem;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-primary);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            overflow-x: auto;
            max-width: 2000px;
            margin: 0 auto;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            color: var(--text-muted);
        }
        .status-item .label { color: var(--text-muted); }
        .status-item .value { color: var(--accent-cyan); font-weight: 600; }
        .status-item .value.alert { color: var(--accent-red); }
        .status-item .value.positive { color: var(--accent-green); }

        /* League Filter Bar */
        .league-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            overflow-x: auto;
            max-width: 2000px;
            margin: 0 auto;
        }

        .league-chip {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .league-chip:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .league-chip.active {
            background: rgba(88, 166, 255, 0.15);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
        .league-chip .count {
            background: var(--bg-primary);
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        .league-chip.active .count { background: var(--accent-cyan); color: var(--bg-primary); }

        /* Data Layer Toggles */
        .layer-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem;
            background: rgba(22, 27, 34, 0.8);
            border-bottom: 1px solid var(--border-primary);
            overflow-x: auto;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        .layer-toggle:hover { border-color: var(--text-secondary); color: var(--text-secondary); }
        .layer-toggle.active { background: rgba(88, 166, 255, 0.1); border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .layer-toggle.active.live { background: rgba(248, 81, 73, 0.1); border-color: var(--accent-red); color: var(--accent-red); }
        .layer-toggle.active.weather { background: rgba(88, 166, 255, 0.1); border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .layer-toggle.active.movement { background: rgba(210, 153, 34, 0.1); border-color: var(--accent-yellow); color: var(--accent-yellow); }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 0;
            height: calc(100vh - 160px);
            max-width: 2000px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        /* Map Container */
        .map-section {
            position: relative;
            border-right: 1px solid var(--border-primary);
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }

        .maplibregl-popup-content {
            background: var(--bg-card) !important;
            border: 1px solid var(--accent-cyan) !important;
            border-radius: 8px !important;
            padding: 0 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
        }

        .maplibregl-popup-tip {
            border-top-color: var(--accent-cyan) !important;
        }

        .map-popup {
            padding: 0.75rem;
            min-width: 220px;
            font-family: var(--font-sans);
        }

        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .popup-league {
            font-size: 0.7rem;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .popup-status {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
        }
        .popup-status.live { background: var(--accent-red); color: white; }
        .popup-status.upcoming { background: var(--accent-green); color: white; }

        .popup-teams {
            margin-bottom: 0.5rem;
        }

        .popup-team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
        }

        .popup-team-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .popup-odds {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .popup-meta {
            display: flex;
            gap: 0.75rem;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Map Controls Overlay */
        .map-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-stat-box {
            background: rgba(13, 17, 23, 0.9);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            backdrop-filter: blur(10px);
        }

        .map-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-stat-value {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        .map-stat-value.alert { color: var(--accent-red); }

        /* Right Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel {
            border-bottom: 1px solid var(--border-primary);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
        }

        .panel-title {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
        }
        .panel-badge.live { background: var(--accent-red); color: white; }
        .panel-badge.data { background: var(--accent-cyan); color: var(--bg-primary); }
        .panel-badge.alert { background: var(--accent-yellow); color: var(--bg-primary); }

        .panel-body {
            padding: 0.75rem 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Market Summary */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .market-item {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 0.6rem;
            text-align: center;
        }

        .market-value {
            font-family: var(--font-mono);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        .market-value.hot { color: var(--accent-red); }
        .market-value.good { color: var(--accent-green); }

        .market-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 0.2rem;
        }

        /* Intel Feed */
        .intel-feed {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .intel-item {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 0.6rem;
            border-left: 3px solid var(--accent-cyan);
            transition: background 0.2s;
        }
        .intel-item:hover { background: var(--bg-tertiary); }
        .intel-item.injury { border-left-color: var(--accent-red); }
        .intel-item.movement { border-left-color: var(--accent-yellow); }
        .intel-item.value { border-left-color: var(--accent-green); }
        .intel-item.weather { border-left-color: var(--accent-cyan); }

        .intel-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.3rem;
        }

        .intel-type {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .intel-item.injury .intel-type { color: var(--accent-red); }
        .intel-item.movement .intel-type { color: var(--accent-yellow); }
        .intel-item.value .intel-type { color: var(--accent-green); }
        .intel-item.weather .intel-type { color: var(--accent-cyan); }

        .intel-time {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .intel-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .intel-source {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 0.3rem;
        }

        /* Line Movement */
        .movement-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
            margin-bottom: 0.4rem;
        }

        .movement-match {
            flex: 1;
        }

        .movement-teams {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .movement-league {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .movement-change {
            text-align: right;
        }

        .movement-arrow {
            font-size: 1rem;
        }
        .movement-arrow.up { color: var(--accent-green); }
        .movement-arrow.down { color: var(--accent-red); }

        .movement-odds {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Twitter/X Takes Panel */
        .take-item {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-primary);
        }

        .take-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .take-avatar {
            width: 24px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .take-user {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .take-handle {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .take-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 0.4rem;
        }

        .take-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .take-stat {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        /* League Status */
        .league-status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-primary);
        }
        .league-status-item:last-child { border-bottom: none; }

        .league-status-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .league-status-flag {
            font-size: 1rem;
        }

        .league-status-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .league-status-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
        }
        .league-status-badge.active { background: var(--accent-green); color: white; }
        .league-status-badge.upcoming { background: var(--accent-cyan); color: var(--bg-primary); }
        .league-status-badge.finished { background: var(--bg-tertiary); color: var(--text-muted); }

        /* Match List (below map) */
        .match-list-section {
            padding: 1rem 1.5rem;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-primary);
        }

        .match-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .match-list-title {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 0.75rem;
        }

        .match-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s;
        }
        .match-card:hover { border-color: var(--accent-cyan); }
        .match-card.live { border-left: 3px solid var(--accent-red); }

        .match-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .match-league {
            font-size: 0.65rem;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .match-time {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .match-status-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 700;
        }
        .match-status-badge.live { background: var(--accent-red); color: white; animation: pulse 1.5s infinite; }
        .match-status-badge.soon { background: var(--accent-yellow); color: var(--bg-primary); }

        .match-teams {
            margin-bottom: 0.5rem;
        }

        .match-team-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
        }

        .match-team-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .match-odds {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-yellow);
            padding: 0.2rem 0.5rem;
            background: rgba(210, 153, 34, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .match-odds:hover { background: rgba(210, 153, 34, 0.2); }
        .match-odds.up { color: var(--accent-green); background: rgba(63, 185, 80, 0.1); }
        .match-odds.down { color: var(--accent-red); background: rgba(248, 81, 73, 0.1); }

        .match-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .match-indicator {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
        }
        .match-indicator.injury { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }
        .match-indicator.weather { background: rgba(88, 166, 255, 0.15); color: var(--accent-cyan); }
        .match-indicator.value { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .match-indicator.movement { background: rgba(210, 153, 34, 0.15); color: var(--accent-yellow); }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border-primary);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.75rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* Custom marker styles */
        .map-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .map-marker.live {
            background: var(--accent-red);
            animation: markerPulse 2s ease-in-out infinite;
        }

        .map-marker.upcoming {
            background: var(--accent-cyan);
        }

        @keyframes markerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(248, 81, 73, 0); }
        }

        /* Rich Popup Styles */
        .maplibregl-popup-content {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            padding: 0 !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
        }
        .maplibregl-popup-tip {
            border-top-color: var(--bg-secondary) !important;
        }
        
        .rich-popup {
            min-width: 300px;
            max-width: 360px;
            color: var(--text-primary);
            font-family: var(--font-sans);
        }
        
        .rich-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .rich-popup .popup-league {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .rich-popup .popup-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--bg-card);
        }
        .rich-popup .popup-status.live {
            background: var(--accent-red);
            color: white;
        }
        
        .rich-popup .popup-matchup {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            gap: 12px;
        }
        
        .rich-popup .popup-team {
            flex: 1;
            text-align: center;
        }
        .rich-popup .popup-team .team-name {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .rich-popup .popup-team .team-odds {
            display: inline-block;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-cyan);
            background: rgba(88, 166, 255, 0.1);
            padding: 4px 12px;
            border-radius: 6px;
        }
        
        .rich-popup .popup-vs {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
        }
        .rich-popup .popup-vs .vs-text {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .rich-popup .popup-vs .vs-time {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .rich-popup .popup-draw {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0 16px 12px;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .rich-popup .popup-weather {
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-primary);
        }
        .rich-popup .weather-loading {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .rich-popup .weather-data {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .rich-popup .weather-main {
            font-size: 1rem;
            font-weight: 600;
        }
        .rich-popup .weather-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .rich-popup .weather-data.good .weather-main { color: var(--accent-green); }
        .rich-popup .weather-data.caution .weather-main { color: var(--accent-yellow); }
        .rich-popup .weather-data.bad .weather-main { color: var(--accent-red); }
        .rich-popup .weather-note {
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--accent-yellow);
            font-weight: 500;
        }
        .rich-popup .weather-unavailable {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .rich-popup .weather-indoor {
            font-size: 0.85rem;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rich-popup .popup-intel {
            padding: 12px 16px;
        }
        .rich-popup .intel-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .rich-popup .intel-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-primary);
        }
        .rich-popup .intel-item:last-child { border-bottom: none; }
        .rich-popup .intel-icon { font-size: 0.85rem; }
        .rich-popup .intel-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .rich-popup .intel-item.angle .intel-text { color: var(--accent-yellow); font-weight: 500; }
        
        .rich-popup .popup-footer {
            display: flex;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-main { padding: 0.5rem 1rem; }
            .header-center { display: none; }
            .league-bar { padding: 0.5rem 1rem; }
            .match-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-main">
            <div class="logo-section">
                <div class="logo-icon">üåç</div>
                <div>
                    <div class="logo-text">SPORTS MONITOR</div>
                    <div class="logo-tag">Global Intelligence Platform</div>
                </div>
            </div>
            
            <div class="header-center">
                <a href="index.html" class="nav-link">üéÆ Esports</a>
                <a href="#" class="nav-link active">‚öΩ Sports</a>
            </div>

            <div class="header-right">
                <div class="live-clock">
                    <span class="live-dot"></span>
                    <span id="utc-time">--:--:-- UTC</span>
                </div>
                <div id="loading-status" style="font-size: 0.7rem; color: var(--accent-cyan); opacity: 0.6; margin-left: 1rem; font-family: var(--font-mono);">Loading...</div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="label">LIVE:</span>
                <span class="value alert" id="status-live">--</span>
            </div>
            <div class="status-item">
                <span class="label">TODAY:</span>
                <span class="value" id="status-today">--</span>
            </div>
            <div class="status-item">
                <span class="label">NEXT 24H:</span>
                <span class="value" id="status-upcoming">--</span>
            </div>
            <div class="status-item">
                <span class="label">LEAGUES ACTIVE:</span>
                <span class="value" id="status-leagues">--</span>
            </div>
            <div class="status-item">
                <span class="label">LINE MOVEMENTS:</span>
                <span class="value alert" id="status-movements">--</span>
            </div>
            <div class="status-item">
                <span class="label">LAST UPDATE:</span>
                <span class="value" id="status-update">--</span>
            </div>
        </div>
    </header>

    <!-- League Filter Bar -->
    <nav class="league-bar" id="league-bar">
        <div class="league-chip active" data-league="all">üåê All <span class="count" id="count-all">--</span></div>
        <div class="league-chip" data-league="premier-league">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø EPL <span class="count" id="count-pl">--</span></div>
        <div class="league-chip" data-league="la-liga">üá™üá∏ La Liga <span class="count" id="count-ll">--</span></div>
        <div class="league-chip" data-league="bundesliga">üá©üá™ Bundesliga <span class="count" id="count-bl">--</span></div>
        <div class="league-chip" data-league="serie-a">üáÆüáπ Serie A <span class="count" id="count-sa">--</span></div>
        <div class="league-chip" data-league="ligue-1">üá´üá∑ Ligue 1 <span class="count" id="count-l1">--</span></div>
        <div class="league-chip" data-league="nba">üèÄ NBA <span class="count" id="count-nba">--</span></div>
        <div class="league-chip" data-league="nhl">üèí NHL <span class="count" id="count-nhl">--</span></div>
        <div class="league-chip" data-league="afl">üèâ AFL <span class="count" id="count-afl">--</span></div>
        <div class="league-chip" data-league="americas">üåé Americas <span class="count" id="count-am">--</span></div>
        <div class="league-chip" data-league="asia">üåè Asia <span class="count" id="count-asia">--</span></div>
        <div class="league-chip" data-league="europe-other">üá™üá∫ EUR Other <span class="count" id="count-eur">--</span></div>
        <div class="league-chip" data-league="tier2">üìâ 2nd Tiers <span class="count" id="count-t2">--</span></div>
    </nav>

    <!-- Data Layer Toggles -->
    <div class="layer-bar">
        <div class="layer-toggle active live" data-layer="live">üî¥ Live Matches</div>
        <div class="layer-toggle active" data-layer="upcoming">üìÖ Upcoming (24h)</div>
        <div class="layer-toggle weather" data-layer="weather">üå§Ô∏è Weather</div>
        <div class="layer-toggle movement active" data-layer="movement">üìà Line Movement</div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Map Section -->
        <div class="map-section">
            <div id="map"></div>
            
            <!-- Map Overlay Stats -->
            <div class="map-overlay">
                <div class="map-stat-box">
                    <div class="map-stat-label">Live Now</div>
                    <div class="map-stat-value alert" id="map-live">--</div>
                </div>
                <div class="map-stat-box">
                    <div class="map-stat-label">On Map</div>
                    <div class="map-stat-value" id="map-total">--</div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <aside class="sidebar">
            <!-- Market Summary -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìä Market Summary</div>
                    <span class="panel-badge data">LIVE</span>
                </div>
                <div class="panel-body">
                    <div class="market-grid">
                        <div class="market-item">
                            <div class="market-value hot" id="market-live">--</div>
                            <div class="market-label">Live Matches</div>
                        </div>
                        <div class="market-item">
                            <div class="market-value" id="market-today">--</div>
                            <div class="market-label">Today Total</div>
                        </div>
                        <div class="market-item">
                            <div class="market-value good" id="market-leagues">--</div>
                            <div class="market-label">Active Leagues</div>
                        </div>
                        <div class="market-item">
                            <div class="market-value" id="market-volume">--</div>
                            <div class="market-label">Markets Open</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Intel Feed -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üì° Live Intel Feed</div>
                    <span class="panel-badge live">REAL-TIME</span>
                </div>
                <div class="panel-body">
                    <div class="intel-feed" id="intel-feed">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div>Loading intel...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Line Movement -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìà Line Movement</div>
                    <span class="panel-badge alert">TRACKING</span>
                </div>
                <div class="panel-body" id="movement-feed">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div>Tracking lines...</div>
                    </div>
                </div>
            </div>

            <!-- Twitter/X Sports Takes -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">ùïè Smart Takes</div>
                    <span class="panel-badge data">CURATED</span>
                </div>
                <div class="panel-body" id="takes-feed">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div>Loading takes...</div>
                    </div>
                </div>
            </div>

            <!-- League Status -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üèÜ League Status</div>
                </div>
                <div class="panel-body" id="league-status">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Match List Section -->
    <section class="match-list-section">
        <div class="match-list-header">
            <div class="match-list-title">üìã All Matches</div>
            <div id="match-count-label" style="font-size: 0.75rem; color: var(--text-muted);">Loading...</div>
        </div>
        <div class="match-grid" id="match-grid">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div>Loading global sports data...</div>
            </div>
        </div>
    </section>

    <script>
        // ============================================================================
        // CONFIGURATION - Using OpenFootball (free, no auth, CORS-enabled)
        // ============================================================================
        const CONFIG = {
            OPENFOOTBALL_BASE: 'https://raw.githubusercontent.com/openfootball/football.json/master',
            REFRESH_INTERVAL: 300000, // 5 minutes (static data)
            MAP_STYLE: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            
            // PRIORITY LEAGUES - Load first for fast initial render (5 top leagues only)
            PRIORITY_LEAGUES: {
                'premier-league': { file: '2025-26/en.1.json', name: 'English Premier League', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', country: 'England' },
                'la-liga': { file: '2025-26/es.1.json', name: 'Spanish La Liga', flag: 'üá™üá∏', country: 'Spain' },
                'bundesliga': { file: '2025-26/de.1.json', name: 'German Bundesliga', flag: 'üá©üá™', country: 'Germany' },
                'serie-a': { file: '2025-26/it.1.json', name: 'Italian Serie A', flag: 'üáÆüáπ', country: 'Italy' },
                'ligue-1': { file: '2025-26/fr.1.json', name: 'French Ligue 1', flag: 'üá´üá∑', country: 'France' }
            },
            
            // SECONDARY LEAGUES - Load in background after initial render
            SECONDARY_LEAGUES: {
                'championship': { file: '2025-26/en.2.json', name: 'EFL Championship', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', country: 'England' },
                'league-one': { file: '2025-26/en.3.json', name: 'EFL League One', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', country: 'England' },
                'league-two': { file: '2025-26/en.4.json', name: 'EFL League Two', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', country: 'England' },
                'la-liga-2': { file: '2025-26/es.2.json', name: 'Spanish Segunda', flag: 'üá™üá∏', country: 'Spain' },
                'bundesliga-2': { file: '2025-26/de.2.json', name: '2. Bundesliga', flag: 'üá©üá™', country: 'Germany' },
                'serie-b': { file: '2025-26/it.2.json', name: 'Italian Serie B', flag: 'üáÆüáπ', country: 'Italy' },
                'ligue-2': { file: '2025-26/fr.2.json', name: 'French Ligue 2', flag: 'üá´üá∑', country: 'France' },
                'eredivisie': { file: '2025-26/nl.1.json', name: 'Dutch Eredivisie', flag: 'üá≥üá±', country: 'Netherlands' },
                'primeira-liga': { file: '2025-26/pt.1.json', name: 'Portuguese Liga', flag: 'üáµüáπ', country: 'Portugal' },
                'belgian-pro': { file: '2025-26/be.1.json', name: 'Belgian Pro League', flag: 'üáßüá™', country: 'Belgium' },
                'scottish-prem': { file: '2025-26/sco.1.json', name: 'Scottish Premiership', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', country: 'Scotland' },
                'super-lig': { file: '2025-26/tr.1.json', name: 'Turkish S√ºper Lig', flag: 'üáπüá∑', country: 'Turkey' },
                'super-league-gr': { file: '2025-26/gr.1.json', name: 'Greek Super League', flag: 'üá¨üá∑', country: 'Greece' },
                'bundesliga-at': { file: '2025-26/at.1.json', name: 'Austrian Bundesliga', flag: 'üá¶üáπ', country: 'Austria' }
            },
            
            // Combined for compatibility
            get LEAGUE_FILES() {
                return { ...this.PRIORITY_LEAGUES, ...this.SECONDARY_LEAGUES };
            },
            
            // Weather API (free, no key)
            WEATHER_API: 'https://api.open-meteo.com/v1/forecast',
            // ESPN API (free, no key, hidden endpoints)
            ESPN_API: 'https://site.api.espn.com/apis/site/v2/sports',
            
            // PRIORITY ESPN - Load first
            PRIORITY_ESPN: {
                'nba': { sport: 'basketball', league: 'nba', name: 'NBA', flag: 'üèÄ' },
                'nhl': { sport: 'hockey', league: 'nhl', name: 'NHL', flag: 'üèí' }
            },
            
            // SECONDARY ESPN - Load in background
            SECONDARY_ESPN: {
                'afl': { sport: 'australian-football', league: 'afl', name: 'AFL', flag: 'üèâ' },
                'mls': { sport: 'soccer', league: 'usa.1', name: 'MLS', flag: 'üá∫üá∏' },
                'liga-mx': { sport: 'soccer', league: 'mex.1', name: 'Liga MX', flag: 'üá≤üáΩ' },
                'arg-liga': { sport: 'soccer', league: 'arg.1', name: 'Argentina Liga', flag: 'üá¶üá∑' },
                'brazil-serie-a': { sport: 'soccer', league: 'bra.1', name: 'Brazil S√©rie A', flag: 'üáßüá∑' },
                'j-league': { sport: 'soccer', league: 'jpn.1', name: 'J-League', flag: 'üáØüáµ' },
                'india-isl': { sport: 'soccer', league: 'ind.1', name: 'India ISL', flag: 'üáÆüá≥' },
                'saudi-pro': { sport: 'soccer', league: 'sau.1', name: 'Saudi Pro', flag: 'üá∏üá¶' }
            },
            
            // Combined for compatibility
            get ESPN_LEAGUES() {
                return { ...this.PRIORITY_ESPN, ...this.SECONDARY_ESPN };
            }
        };

        // ============================================================================
        // STADIUM COORDINATES DATABASE
        // ============================================================================
        const STADIUMS = {
            // ENGLAND - Premier League
            "Anfield": [53.4308, -2.9608],
            "Old Trafford": [53.4631, -2.2913],
            "Emirates Stadium": [51.5549, -0.1084],
            "Stamford Bridge": [51.4816, -0.1909],
            "Etihad Stadium": [53.4831, -2.2004],
            "Tottenham Hotspur Stadium": [51.6043, -0.0666],
            "London Stadium": [51.5387, -0.0166],
            "St James' Park": [54.9756, -1.6217],
            "Villa Park": [52.5092, -1.8847],
            "Goodison Park": [53.4388, -2.9663],
            "Molineux Stadium": [52.5903, -2.1306],
            "King Power Stadium": [52.6203, -1.1422],
            "Elland Road": [53.7779, -1.5721],
            "Craven Cottage": [51.4750, -0.2217],
            "Selhurst Park": [51.3983, -0.0856],
            "The Amex": [50.8619, -0.0837],
            "Brentford Community Stadium": [51.4907, -0.2886],
            "Vitality Stadium": [50.7352, -1.8382],
            "Portman Road": [52.0550, 1.1447],
            "City Ground": [52.9399, -1.1325],
            
            // SPAIN - La Liga
            "Santiago Bernab√©u": [40.4531, -3.6883],
            "Camp Nou": [41.3809, 2.1228],
            "Wanda Metropolitano": [40.4362, -3.5995],
            "Ram√≥n S√°nchez-Pizju√°n": [37.3841, -5.9705],
            "San Mam√©s": [43.2643, -2.9494],
            "Mestalla": [39.4748, -0.3583],
            "Benito Villamar√≠n": [37.3564, -5.9817],
            "RCDE Stadium": [41.3479, 2.0756],
            "Anoeta": [43.3013, -1.9736],
            "Bala√≠dos": [42.2117, -8.7394],
            "El Sadar": [42.7967, -1.6369],
            "Montilivi": [41.9608, 2.8283],
            "Nuevo Los C√°rmenes": [37.1528, -3.5958],
            "Son Moix": [39.5900, 2.6300],
            "Reale Arena": [43.3013, -1.9736],
            
            // GERMANY - Bundesliga
            "Allianz Arena": [48.2188, 11.6247],
            "Signal Iduna Park": [51.4926, 7.4518],
            "Olympiastadion Berlin": [52.5147, 13.2395],
            "Volksparkstadion": [53.5872, 9.8986],
            "Mercedes-Benz Arena": [48.7924, 9.2320],
            "Veltins-Arena": [51.5536, 7.0678],
            "RheinEnergieStadion": [50.9335, 6.8749],
            "Red Bull Arena Leipzig": [51.3459, 12.3483],
            "BayArena": [51.0384, 7.0024],
            "Borussia-Park": [51.1747, 6.3856],
            "Deutsche Bank Park": [50.0686, 8.6456],
            "WWK Arena": [48.3232, 10.8858],
            "Europa-Park Stadion": [48.0217, 7.8299],
            "Weserstadion": [53.0664, 8.8375],
            "PreZero Arena": [49.2388, 8.8883],
            "Stadion An der Alten F√∂rsterei": [52.4572, 13.5678],
            "Mewa Arena": [49.9843, 8.2245],
            "Vonovia Ruhrstadion": [51.4898, 7.2364],
            
            // ITALY - Serie A
            "San Siro": [45.4781, 9.1240],
            "Allianz Stadium": [45.1096, 7.6413],
            "Stadio Olimpico": [41.9341, 12.4547],
            "Stadio Diego Armando Maradona": [40.8279, 14.1931],
            "Stadio Artemio Franchi": [43.7808, 11.2822],
            "Stadio Renato Dall'Ara": [44.4923, 11.3097],
            "Gewiss Stadium": [45.7089, 9.6808],
            "Stadio Marc'Antonio Bentegodi": [45.4353, 10.9686],
            "Mapei Stadium": [44.7136, 10.6550],
            "Stadio Friuli": [46.0817, 13.2000],
            "Stadio Via del Mare": [40.3533, 18.1772],
            "Stadio Carlo Castellani": [43.7264, 10.9500],
            "Sardegna Arena": [39.1997, 9.1375],
            "Stadio Ennio Tardini": [44.7953, 10.3383],
            "Stadio Ciro Vigorito": [41.1167, 14.7833],
            "U-Power Stadium": [45.5206, 9.3028],
            
            // FRANCE - Ligue 1
            "Parc des Princes": [48.8414, 2.2530],
            "Groupama Stadium": [45.7653, 4.9822],
            "Stade V√©lodrome": [43.2697, 5.3958],
            "Allianz Riviera": [43.7050, 7.1925],
            "Matmut Atlantique": [44.8975, -0.5614],
            "Roazhon Park": [48.1075, -1.7128],
            "Stade Pierre-Mauroy": [50.6119, 3.1303],
            "Stade de la Beaujoire": [47.2561, -1.5247],
            "Stade Bollaert-Delelis": [50.4319, 2.8147],
            "Stade Auguste-Delaune": [49.2469, 4.0253],
            "Stade de la Mosson": [43.6222, 3.8119],
            "Stade Geoffroy-Guichard": [45.4608, 4.3903],
            "Stadium de Toulouse": [43.5833, 1.4344],
            "Stade Francis-Le Bl√©": [48.4028, -4.4617],
            "Stade Louis II": [43.7275, 7.4153],
            "Meinau Stadium": [48.5600, 7.7550],
            
            // UEFA - Champions League venues
            "Wembley Stadium": [51.5560, -0.2796],
            "Stade de France": [48.9244, 2.3601],
            "Estadio da Luz": [38.7527, -9.1847],
            "Johan Cruyff Arena": [52.3142, 4.9419],
            "Est√°dio do Drag√£o": [41.1617, -8.5833],
            
            // USA - NBA/NFL/MLB/NHL Cities
            "Madison Square Garden": [40.7505, -73.9934],
            "Barclays Center": [40.6826, -73.9754],
            "TD Garden": [42.3662, -71.0621],
            "United Center": [41.8807, -87.6742],
            "Staples Center": [34.0430, -118.2673],
            "Chase Center": [37.7680, -122.3877],
            "American Airlines Center": [32.7905, -96.8103],
            "Toyota Center": [29.7508, -95.3621],
            "Ball Arena": [39.7487, -105.0077],
            "Fiserv Forum": [43.0451, -87.9172],
            "State Farm Arena": [33.7573, -84.3963],
            "Footprint Center": [33.4457, -112.0712],
            "Capital One Arena": [38.8981, -77.0209],
            "Wells Fargo Center": [39.9012, -75.1720],
            "Little Caesars Arena": [42.3411, -83.0553],
            "Scotiabank Arena": [43.6435, -79.3791],
            
            // NFL Stadiums
            "SoFi Stadium": [33.9535, -118.3392],
            "Allegiant Stadium": [36.0909, -115.1833],
            "AT&T Stadium": [32.7473, -97.0945],
            "MetLife Stadium": [40.8128, -74.0742],
            "Lumen Field": [47.5952, -122.3316],
            "Lambeau Field": [44.5013, -88.0622],
            "Arrowhead Stadium": [39.0489, -94.4839],
            "Hard Rock Stadium": [25.9580, -80.2389],
            "Gillette Stadium": [42.0909, -71.2643],
            "M&T Bank Stadium": [39.2780, -76.6227],
            
            // NHL Arenas (additional)
            "Rogers Place": [53.5469, -113.4979],
            "Bell Centre": [45.4961, -73.5693],
            "Amalie Arena": [27.9428, -82.4519],
            "T-Mobile Arena": [36.1029, -115.1784],
            
            // MLB Parks
            "Yankee Stadium": [40.8296, -73.9262],
            "Dodger Stadium": [34.0739, -118.2400],
            "Fenway Park": [42.3467, -71.0972],
            "Wrigley Field": [41.9484, -87.6553],
            "Oracle Park": [37.7786, -122.3893],
            "Truist Park": [33.8907, -84.4678],
            "Globe Life Field": [32.7473, -97.0845],
            "Citi Field": [40.7571, -73.8458],
            "Minute Maid Park": [29.7573, -95.3555],
            "Target Field": [44.9817, -93.2776]
        };

        // Team to stadium/city mapping
        const TEAM_LOCATIONS = {
            // Premier League
            "Liverpool": "Anfield",
            "Manchester United": "Old Trafford",
            "Manchester City": "Etihad Stadium",
            "Arsenal": "Emirates Stadium",
            "Chelsea": "Stamford Bridge",
            "Tottenham": "Tottenham Hotspur Stadium",
            "West Ham": "London Stadium",
            "Newcastle": "St James' Park",
            "Aston Villa": "Villa Park",
            "Everton": "Goodison Park",
            "Wolves": "Molineux Stadium",
            "Leicester": "King Power Stadium",
            "Leeds": "Elland Road",
            "Fulham": "Craven Cottage",
            "Crystal Palace": "Selhurst Park",
            "Brighton": "The Amex",
            "Brentford": "Brentford Community Stadium",
            "Bournemouth": "Vitality Stadium",
            "Ipswich": "Portman Road",
            "Nottingham Forest": "City Ground",
            
            // La Liga
            "Real Madrid": "Santiago Bernab√©u",
            "Barcelona": "Camp Nou",
            "Atletico Madrid": "Wanda Metropolitano",
            "Sevilla": "Ram√≥n S√°nchez-Pizju√°n",
            "Athletic Bilbao": "San Mam√©s",
            "Valencia": "Mestalla",
            "Real Betis": "Benito Villamar√≠n",
            "Real Sociedad": "Anoeta",
            "Villarreal": "Estadio de la Cer√°mica",
            "Celta Vigo": "Bala√≠dos",
            "Osasuna": "El Sadar",
            "Girona": "Montilivi",
            "Granada": "Nuevo Los C√°rmenes",
            "Mallorca": "Son Moix",
            
            // Bundesliga
            "Bayern Munich": "Allianz Arena",
            "Borussia Dortmund": "Signal Iduna Park",
            "RB Leipzig": "Red Bull Arena Leipzig",
            "Bayer Leverkusen": "BayArena",
            "Eintracht Frankfurt": "Deutsche Bank Park",
            "Borussia Monchengladbach": "Borussia-Park",
            "Wolfsburg": "Volkswagen Arena",
            "FC Koln": "RheinEnergieStadion",
            "Union Berlin": "Stadion An der Alten F√∂rsterei",
            "Freiburg": "Europa-Park Stadion",
            "Augsburg": "WWK Arena",
            "Hoffenheim": "PreZero Arena",
            "Mainz": "Mewa Arena",
            "Werder Bremen": "Weserstadion",
            "VfB Stuttgart": "Mercedes-Benz Arena",
            "Bochum": "Vonovia Ruhrstadion",
            "Hertha Berlin": "Olympiastadion Berlin",
            "Schalke": "Veltins-Arena",
            
            // Serie A
            "AC Milan": "San Siro",
            "Inter Milan": "San Siro",
            "Juventus": "Allianz Stadium",
            "Roma": "Stadio Olimpico",
            "Lazio": "Stadio Olimpico",
            "Napoli": "Stadio Diego Armando Maradona",
            "Fiorentina": "Stadio Artemio Franchi",
            "Atalanta": "Gewiss Stadium",
            "Bologna": "Stadio Renato Dall'Ara",
            "Torino": "Stadio Olimpico Grande Torino",
            "Verona": "Stadio Marc'Antonio Bentegodi",
            "Sassuolo": "Mapei Stadium",
            "Udinese": "Stadio Friuli",
            "Lecce": "Stadio Via del Mare",
            "Empoli": "Stadio Carlo Castellani",
            "Cagliari": "Sardegna Arena",
            "Parma": "Stadio Ennio Tardini",
            "Monza": "U-Power Stadium",
            
            // Ligue 1
            "PSG": "Parc des Princes",
            "Paris Saint-Germain": "Parc des Princes",
            "Lyon": "Groupama Stadium",
            "Marseille": "Stade V√©lodrome",
            "Nice": "Allianz Riviera",
            "Lille": "Stade Pierre-Mauroy",
            "Rennes": "Roazhon Park",
            "Monaco": "Stade Louis II",
            "Nantes": "Stade de la Beaujoire",
            "Lens": "Stade Bollaert-Delelis",
            "Reims": "Stade Auguste-Delaune",
            "Montpellier": "Stade de la Mosson",
            "Saint-Etienne": "Stade Geoffroy-Guichard",
            "Toulouse": "Stadium de Toulouse",
            "Strasbourg": "Meinau Stadium",
            "Brest": "Stade Francis-Le Bl√©",
            
            // NBA
            "Lakers": "Staples Center",
            "Clippers": "Staples Center",
            "Knicks": "Madison Square Garden",
            "Nets": "Barclays Center",
            "Celtics": "TD Garden",
            "Bulls": "United Center",
            "Warriors": "Chase Center",
            "Mavericks": "American Airlines Center",
            "Rockets": "Toyota Center",
            "Nuggets": "Ball Arena",
            "Bucks": "Fiserv Forum",
            "Hawks": "State Farm Arena",
            "Suns": "Footprint Center",
            "Wizards": "Capital One Arena",
            "76ers": "Wells Fargo Center",
            "Pistons": "Little Caesars Arena",
            "Raptors": "Scotiabank Arena",
            
            // NFL
            "Chiefs": "Arrowhead Stadium",
            "Cowboys": "AT&T Stadium",
            "Patriots": "Gillette Stadium",
            "Ravens": "M&T Bank Stadium",
            "Dolphins": "Hard Rock Stadium",
            "Packers": "Lambeau Field",
            "Seahawks": "Lumen Field",
            "Raiders": "Allegiant Stadium",
            "Rams": "SoFi Stadium",
            "Chargers": "SoFi Stadium",
            "Giants": "MetLife Stadium",
            "Jets": "MetLife Stadium"
        };

        // ============================================================================
        // CACHE CONFIGURATION (15-minute TTL)
        // ============================================================================
        const CACHE = {
            TTL_MS: 15 * 60 * 1000, // 15 minutes
            KEYS: {
                OPENFOOTBALL: 'sm_cache_openfootball',
                ESPN: 'sm_cache_espn',
                TIMESTAMP: 'sm_cache_timestamp'
            },
            
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    const timestamp = localStorage.getItem(this.KEYS.TIMESTAMP + '_' + key);
                    if (!data || !timestamp) return null;
                    if (Date.now() - parseInt(timestamp) > this.TTL_MS) {
                        this.clear(key);
                        return null;
                    }
                    return JSON.parse(data);
                } catch (e) {
                    console.warn('Cache read failed:', e);
                    return null;
                }
            },
            
            set(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    localStorage.setItem(this.KEYS.TIMESTAMP + '_' + key, Date.now().toString());
                } catch (e) {
                    console.warn('Cache write failed:', e);
                }
            },
            
            clear(key) {
                localStorage.removeItem(key);
                localStorage.removeItem(this.KEYS.TIMESTAMP + '_' + key);
            },
            
            getAge(key) {
                const timestamp = localStorage.getItem(this.KEYS.TIMESTAMP + '_' + key);
                if (!timestamp) return null;
                return Math.round((Date.now() - parseInt(timestamp)) / 1000 / 60); // minutes
            }
        };

        // ============================================================================
        // STATE
        // ============================================================================
        let map = null;
        let markers = [];
        let allMatches = [];
        let activeLeague = 'all';
        let activeLayers = { live: true, upcoming: true, weather: false, movement: true };
        let loadingState = { openfootball: false, espn: false };

        // ============================================================================
        // INITIALIZE MAP
        // ============================================================================
        let mapLoaded = false;
        let dataLoaded = false;
        let pendingMatches = null;
        
        function initMap() {
            // Start data fetch IMMEDIATELY (don't wait for map)
            fetchAllMatches();
            
            map = new maplibregl.Map({
                container: 'map',
                style: CONFIG.MAP_STYLE,
                center: [10, 35],
                zoom: 2.5,
                minZoom: 1,
                maxZoom: 12
            });

            map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
            
            map.on('load', () => {
                console.log('Map loaded');
                mapLoaded = true;
                // If data arrived before map loaded, plot it now
                if (pendingMatches) {
                    plotMatchesOnMap();
                    pendingMatches = null;
                }
            });
        }

        // ============================================================================
        // CITY COORDINATES DATABASE
        // ============================================================================
        const CITY_COORDS = {
            // England
            "london": [51.5074, -0.1278], "manchester": [53.4808, -2.2426], "liverpool": [53.4084, -2.9916],
            "birmingham": [52.4862, -1.8904], "leeds": [53.8008, -1.5491], "newcastle": [54.9783, -1.6178],
            "sheffield": [53.3811, -1.4701], "bristol": [51.4545, -2.5879], "nottingham": [52.9548, -1.1581],
            "leicester": [52.6369, -1.1398], "southampton": [50.9097, -1.4044], "portsmouth": [50.8198, -1.0880],
            "brighton": [50.8225, -0.1372], "wolverhampton": [52.5870, -2.1288], "stoke": [53.0027, -2.1794],
            "sunderland": [54.9069, -1.3838], "bournemouth": [50.7192, -1.8808], "ipswich": [52.0567, 1.1482],
            "norwich": [52.6309, 1.2974], "plymouth": [50.3755, -4.1427], "reading": [51.4543, -0.9781],
            "coventry": [52.4068, -1.5197], "derby": [52.9225, -1.4746], "hull": [53.7676, -0.3274],
            "preston": [53.7632, -2.7031], "blackburn": [53.7488, -2.4847], "bolton": [53.5785, -2.4299],
            "wigan": [53.5450, -2.6325], "luton": [51.8787, -0.4200], "watford": [51.6565, -0.3903],
            "swansea": [51.6214, -3.9436], "cardiff": [51.4816, -3.1791], "exeter": [50.7184, -3.5339],
            "barnsley": [53.5526, -1.4797], "rotherham": [53.4326, -1.3635], "doncaster": [53.5228, -1.1288],
            "bradford": [53.7960, -1.7594], "huddersfield": [53.6450, -1.7798], "middlesbrough": [54.5742, -1.2350],
            "blackpool": [53.8175, -3.0357], "burnley": [53.7897, -2.2480], "wycombe": [51.6287, -0.7482],
            "peterborough": [52.5695, -0.2405], "oxford": [51.7520, -1.2577], "cambridge": [52.2053, 0.1218],
            "stevenage": [51.9017, -0.2019], "crawley": [51.1092, -0.1872], "carlisle": [54.8951, -2.9382],
            "fleetwood": [53.9225, -3.0086], "accrington": [53.7534, -2.3640], "morecambe": [54.0728, -2.8527],
            "harrogate": [53.9921, -1.5418], "salford": [53.4875, -2.2901], "stockport": [53.4106, -2.1575],
            "port vale": [53.0500, -2.1917], "crewe": [53.0988, -2.4402], "shrewsbury": [52.7081, -2.7540],
            "wrexham": [53.0522, -2.9949], "tranmere": [53.3730, -3.0337], "colchester": [51.8891, 0.9035],
            "cheltenham": [51.8994, -2.0783], "forest green": [51.6986, -2.2350], "mansfield": [53.1397, -1.1997],
            "grimsby": [53.5654, -0.0935], "barrow": [54.1108, -3.2267], "gillingham": [51.3851, 0.5608],
            "leyton": [51.5566, -0.0054], "wimbledon": [51.4322, -0.1892], "millwall": [51.4864, -0.0512],
            "charlton": [51.4865, 0.0367], "qpr": [51.5093, -0.2321], "brentford": [51.4882, -0.3026],
            
            // Spain
            "madrid": [40.4168, -3.7038], "barcelona": [41.3851, 2.1734], "valencia": [39.4699, -0.3763],
            "sevilla": [37.3891, -5.9845], "bilbao": [43.2630, -2.9350], "malaga": [36.7213, -4.4214],
            "zaragoza": [41.6488, -0.8891], "murcia": [37.9922, -1.1307], "palma": [39.5696, 2.6502],
            "las palmas": [28.1235, -15.4366], "vigo": [42.2406, -8.7207], "gijon": [43.5322, -5.6611],
            "alicante": [38.3452, -0.4815], "cordoba": [37.8882, -4.7794], "valladolid": [41.6523, -4.7245],
            "vitoria": [42.8467, -2.6726], "granada": [37.1773, -3.5986], "oviedo": [43.3619, -5.8494],
            "pamplona": [42.8125, -1.6458], "san sebastian": [43.3183, -1.9812], "santander": [43.4623, -3.8099],
            "almeria": [36.8340, -2.4637], "cadiz": [36.5271, -6.2886], "huelva": [37.2614, -6.9447],
            "elche": [38.2669, -0.6983], "getafe": [40.3047, -3.7311], "leganes": [40.3281, -3.7636],
            "rayo vallecano": [40.3919, -3.6589], "celta": [42.2117, -8.7394], "osasuna": [42.8125, -1.6458],
            "girona": [41.9794, 2.8214], "levante": [39.4699, -0.3763], "espanyol": [41.3851, 2.1734],
            "eibar": [43.1847, -2.4722], "huesca": [42.1401, -0.4089], "albacete": [38.9942, -1.8585],
            "tenerife": [28.4636, -16.2518], "sporting gijon": [43.5322, -5.6611], "real oviedo": [43.3619, -5.8494],
            
            // Germany
            "munich": [48.1351, 11.5820], "berlin": [52.5200, 13.4050], "hamburg": [53.5511, 9.9937],
            "frankfurt": [50.1109, 8.6821], "cologne": [50.9375, 6.9603], "stuttgart": [48.7758, 9.1829],
            "dusseldorf": [51.2277, 6.7735], "dortmund": [51.5136, 7.4653], "leipzig": [51.3397, 12.3731],
            "bremen": [53.0793, 8.8017], "hannover": [52.3759, 9.7320], "nuremberg": [49.4521, 11.0767],
            "duisburg": [51.4344, 6.7623], "bochum": [51.4818, 7.2162], "gelsenkirchen": [51.5177, 7.0857],
            "monchengladbach": [51.1805, 6.4428], "augsburg": [48.3705, 10.8978], "freiburg": [47.9990, 7.8421],
            "hoffenheim": [49.2388, 8.8883], "mainz": [49.9929, 8.2473], "wolfsburg": [52.4227, 10.7865],
            "leverkusen": [51.0459, 7.0192], "paderborn": [51.7189, 8.7575], "bielefeld": [52.0302, 8.5325],
            "union berlin": [52.4572, 13.5678], "hertha": [52.5147, 13.2395], "kaiserslautern": [49.4401, 7.7491],
            "karlsruhe": [49.0069, 8.4037], "braunschweig": [52.2689, 10.5268], "dresden": [51.0504, 13.7373],
            "rostock": [54.0924, 12.0991], "magdeburg": [52.1205, 11.6276], "greuther furth": [49.4295, 10.9896],
            "regensburg": [49.0134, 12.1016], "sandhausen": [49.3436, 8.6614], "st pauli": [53.5511, 9.9937],
            "schalke": [51.5536, 7.0678], "koln": [50.9375, 6.9603], "heidenheim": [48.6769, 10.1542],
            "darmstadt": [49.8728, 8.6512], "elversberg": [49.3051, 7.0639], "kiel": [54.3233, 10.1228],
            
            // Italy
            "milan": [45.4642, 9.1900], "rome": [41.9028, 12.4964], "naples": [40.8518, 14.2681],
            "turin": [45.0703, 7.6869], "florence": [43.7696, 11.2558], "bologna": [44.4949, 11.3426],
            "genoa": [44.4056, 8.9463], "venice": [45.4408, 12.3155], "verona": [45.4384, 10.9916],
            "palermo": [38.1157, 13.3615], "bari": [41.1171, 16.8719], "catania": [37.5079, 15.0830],
            "bergamo": [45.6983, 9.6773], "parma": [44.8015, 10.3279], "modena": [44.6471, 10.9252],
            "reggio emilia": [44.6989, 10.6297], "brescia": [45.5416, 10.2118], "cagliari": [39.2238, 9.1217],
            "lecce": [40.3515, 18.1750], "udine": [46.0711, 13.2346], "trieste": [45.6495, 13.7768],
            "perugia": [43.1107, 12.3908], "empoli": [43.7264, 10.9500], "sassuolo": [44.5394, 10.7833],
            "monza": [45.5845, 9.2744], "como": [45.8080, 9.0852], "frosinone": [41.6396, 13.3426],
            "salernitana": [40.6824, 14.7681], "spezia": [44.1024, 9.8240], "cremonese": [45.1346, 10.0244],
            "sampdoria": [44.4056, 8.9463], "pisa": [43.7228, 10.4017], "cosenza": [39.3087, 16.2496],
            "reggina": [38.1089, 15.6475], "ternana": [42.5570, 12.6496], "ascoli": [42.8537, 13.5749],
            "spal": [44.8381, 11.6198], "benevento": [41.1297, 14.7828], "cittadella": [45.6499, 11.7853],
            
            // France
            "paris": [48.8566, 2.3522], "marseille": [43.2965, 5.3698], "lyon": [45.7640, 4.8357],
            "toulouse": [43.6047, 1.4442], "nice": [43.7102, 7.2620], "nantes": [47.2184, -1.5536],
            "strasbourg": [48.5734, 7.7521], "montpellier": [43.6108, 3.8767], "bordeaux": [44.8378, -0.5792],
            "lille": [50.6292, 3.0573], "rennes": [48.1173, -1.6778], "reims": [49.2583, 4.0317],
            "le havre": [49.4944, 0.1079], "saint etienne": [45.4397, 4.3872], "toulon": [43.1242, 5.9280],
            "grenoble": [45.1885, 5.7245], "dijon": [47.3220, 5.0415], "angers": [47.4784, -0.5632],
            "nimes": [43.8367, 4.3601], "clermont": [45.7772, 3.0870], "lens": [50.4333, 2.8333],
            "brest": [48.3904, -4.4861], "metz": [49.1193, 6.1757], "monaco": [43.7384, 7.4246],
            "auxerre": [47.7986, 3.5673], "lorient": [47.7486, -3.3702], "ajaccio": [41.9192, 8.7386],
            "troyes": [48.2973, 4.0744], "caen": [49.1829, -0.3707], "amiens": [49.8941, 2.2958],
            "guingamp": [48.5616, -3.1509], "nancy": [48.6921, 6.1844], "sochaux": [47.5078, 6.7956],
            "laval": [48.0736, -0.7695], "pau": [43.2951, -0.3708], "bastia": [42.6970, 9.4503],
            "rodez": [44.3497, 2.5753], "annecy": [45.8992, 6.1294], "dunkerque": [51.0343, 2.3768],
            
            // Netherlands
            "amsterdam": [52.3676, 4.9041], "rotterdam": [51.9244, 4.4777], "the hague": [52.0705, 4.3007],
            "utrecht": [52.0907, 5.1214], "eindhoven": [51.4416, 5.4697], "tilburg": [51.5555, 5.0913],
            "groningen": [53.2194, 6.5665], "almere": [52.3508, 5.2647], "breda": [51.5719, 4.7683],
            "nijmegen": [51.8126, 5.8372], "arnhem": [51.9851, 5.8987], "enschede": [52.2215, 6.8937],
            "haarlem": [52.3874, 4.6462], "alkmaar": [52.6324, 4.7534], "deventer": [52.2551, 6.1639],
            "emmen": [52.7792, 6.8969], "heerenveen": [52.9601, 5.9214], "zwolle": [52.5168, 6.0830],
            "waalwijk": [51.6873, 5.0705], "sittard": [50.9979, 5.8690], "venlo": [51.3704, 6.1724],
            "volendam": [52.4953, 5.0710], "go ahead eagles": [52.2551, 6.1639], "fortuna": [50.9979, 5.8690],
            "heracles": [52.2630, 6.7915], "sparta": [51.9244, 4.4777], "excelsior": [51.9244, 4.4777],
            
            // Portugal
            "lisbon": [38.7223, -9.1393], "porto": [41.1579, -8.6291], "braga": [41.5518, -8.4229],
            "coimbra": [40.2033, -8.4103], "funchal": [32.6669, -16.9241], "setubal": [38.5244, -8.8882],
            "guimaraes": [41.4425, -8.2918], "faro": [37.0194, -7.9322], "leiria": [39.7436, -8.8071],
            "aveiro": [40.6443, -8.6455], "viseu": [40.6610, -7.9097], "evora": [38.5667, -7.9000],
            "famalicao": [41.4083, -8.5194], "estoril": [38.7057, -9.3983], "boavista": [41.1579, -8.6291],
            "sporting": [38.7223, -9.1393], "benfica": [38.7223, -9.1393], "belenenses": [38.7223, -9.1393],
            "vitoria sc": [41.4425, -8.2918], "maritimo": [32.6669, -16.9241], "santa clara": [37.7833, -25.5167],
            "rio ave": [41.3606, -8.7481], "moreirense": [41.3797, -8.2283], "arouca": [40.9333, -8.2500],
            "pacos ferreira": [41.2806, -8.3833], "tondela": [40.5167, -8.0833], "portimonense": [37.1333, -8.5333],
            "estrela amadora": [38.7589, -9.2353], "casa pia": [38.7223, -9.1393], "chaves": [41.7333, -7.4667],
            
            // Belgium
            "brussels": [50.8503, 4.3517], "antwerp": [51.2194, 4.4025], "ghent": [51.0543, 3.7174],
            "bruges": [51.2093, 3.2247], "liege": [50.6326, 5.5797], "charleroi": [50.4108, 4.4446],
            "namur": [50.4674, 4.8720], "mechelen": [51.0259, 4.4776], "leuven": [50.8798, 4.7005],
            "genk": [50.9655, 5.5001], "kortrijk": [50.8279, 3.2654], "ostend": [51.2254, 2.9187],
            "anderlecht": [50.8503, 4.3517], "standard": [50.6326, 5.5797], "club brugge": [51.2093, 3.2247],
            "gent": [51.0543, 3.7174], "westerlo": [51.0917, 4.9167], "oud-heverlee leuven": [50.8798, 4.7005],
            "sint-truiden": [50.8167, 5.1833], "eupen": [50.6278, 6.0333], "cercle brugge": [51.2093, 3.2247],
            "union sg": [50.8503, 4.3517], "rwdm": [50.8503, 4.3517], "beerschot": [51.2194, 4.4025],
            
            // Scotland
            "glasgow": [55.8642, -4.2518], "edinburgh": [55.9533, -3.1883], "aberdeen": [57.1497, -2.0943],
            "dundee": [56.4620, -2.9707], "perth": [56.3950, -3.4308], "inverness": [57.4778, -4.2247],
            "kilmarnock": [55.6119, -4.4953], "motherwell": [55.7897, -3.9914], "hamilton": [55.7833, -4.0333],
            "livingston": [55.8864, -3.5167], "st johnstone": [56.3950, -3.4308], "ross county": [57.5958, -4.4300],
            "st mirren": [55.8481, -4.4256], "hearts": [55.9533, -3.1883], "hibernian": [55.9533, -3.1883],
            "celtic": [55.8497, -4.2056], "rangers": [55.8531, -4.3092], "partick": [55.8700, -4.2706],
            
            // Turkey
            "istanbul": [41.0082, 28.9784], "ankara": [39.9334, 32.8597], "izmir": [38.4237, 27.1428],
            "antalya": [36.8969, 30.7133], "bursa": [40.1885, 29.0610], "adana": [37.0000, 35.3213],
            "konya": [37.8746, 32.4932], "gaziantep": [37.0662, 37.3833], "trabzon": [41.0027, 39.7168],
            "kayseri": [38.7312, 35.4787], "samsun": [41.2867, 36.3300], "denizli": [37.7765, 29.0864],
            "galatasaray": [41.0082, 28.9784], "fenerbahce": [41.0082, 28.9784], "besiktas": [41.0082, 28.9784],
            "basaksehir": [41.0082, 28.9784], "kasimpasa": [41.0082, 28.9784], "karagumruk": [41.0082, 28.9784],
            "sivasspor": [39.7500, 37.0167], "alanyaspor": [36.5500, 32.0000], "hatayspor": [36.2000, 36.1667],
            "rizespor": [41.0208, 40.5178], "pendikspor": [40.8764, 29.2319], "kayserispor": [38.7312, 35.4787],
            
            // Greece
            "athens": [37.9838, 23.7275], "thessaloniki": [40.6401, 22.9444], "piraeus": [37.9475, 23.6469],
            "patras": [38.2466, 21.7346], "heraklion": [35.3387, 25.1442], "larissa": [39.6390, 22.4191],
            "volos": [39.3666, 22.9507], "ioannina": [39.6650, 20.8537], "kavala": [40.9400, 24.4014],
            "olympiacos": [37.9475, 23.6469], "panathinaikos": [37.9838, 23.7275], "aek": [37.9838, 23.7275],
            "paok": [40.6401, 22.9444], "aris": [40.6401, 22.9444], "asteras tripolis": [37.5094, 22.3764],
            "ofi": [35.3387, 25.1442], "panionios": [37.9838, 23.7275], "atromitos": [38.0500, 23.7333],
            
            // Austria
            "vienna": [48.2082, 16.3738], "graz": [47.0707, 15.4395], "linz": [48.3069, 14.2858],
            "salzburg": [47.8095, 13.0550], "innsbruck": [47.2692, 11.4041], "klagenfurt": [46.6247, 14.3053],
            "villach": [46.6111, 13.8558], "wels": [48.1575, 14.0289], "st polten": [48.2047, 15.6256],
            "rapid vienna": [48.2082, 16.3738], "austria vienna": [48.2082, 16.3738], "sturm graz": [47.0707, 15.4395],
            "lask": [48.3069, 14.2858], "wolfsberger": [46.8417, 14.8431], "hartberg": [47.2806, 15.9667],
            "altach": [47.3564, 9.8656], "ried": [48.2097, 13.4903], "austria klagenfurt": [46.6247, 14.3053],
            
            // South America
            "buenos aires": [-34.6037, -58.3816], "sao paulo": [-23.5505, -46.6333], "rio de janeiro": [-22.9068, -43.1729],
            "bogota": [4.7110, -74.0721], "lima": [-12.0464, -77.0428], "santiago": [-33.4489, -70.6693],
            "caracas": [10.4806, -66.9036], "montevideo": [-34.9011, -56.1645], "quito": [-0.1807, -78.4678],
            "la paz": [-16.4897, -68.1193], "asuncion": [-25.2637, -57.5759], "medellin": [6.2442, -75.5812],
            "rosario": [-32.9587, -60.6930], "cordoba": [-31.4201, -64.1888], "belo horizonte": [-19.9167, -43.9345],
            "porto alegre": [-30.0346, -51.2177], "recife": [-8.0476, -34.8770], "salvador": [-12.9714, -38.5014],
            "fortaleza": [-3.7172, -38.5433], "curitiba": [-25.4284, -49.2733], "brasilia": [-15.7801, -47.9292],
            "cali": [3.4516, -76.5320], "barranquilla": [10.9685, -74.7813], "guayaquil": [-2.1894, -79.8891],
            
            // USA & Canada
            "new york": [40.7128, -74.0060], "los angeles": [34.0522, -118.2437], "chicago": [41.8781, -87.6298],
            "houston": [29.7604, -95.3698], "phoenix": [33.4484, -112.0740], "philadelphia": [39.9526, -75.1652],
            "san antonio": [29.4241, -98.4936], "san diego": [32.7157, -117.1611], "dallas": [32.7767, -96.7970],
            "san jose": [37.3382, -121.8863], "austin": [30.2672, -97.7431], "jacksonville": [30.3322, -81.6557],
            "san francisco": [37.7749, -122.4194], "columbus": [39.9612, -82.9988], "charlotte": [35.2271, -80.8431],
            "indianapolis": [39.7684, -86.1581], "seattle": [47.6062, -122.3321], "denver": [39.7392, -104.9903],
            "washington": [38.9072, -77.0369], "boston": [42.3601, -71.0589], "nashville": [36.1627, -86.7816],
            "baltimore": [39.2904, -76.6122], "oklahoma city": [35.4676, -97.5164], "portland": [45.5152, -122.6784],
            "las vegas": [36.1699, -115.1398], "milwaukee": [43.0389, -87.9065], "albuquerque": [35.0844, -106.6504],
            "tucson": [32.2226, -110.9747], "atlanta": [33.7490, -84.3880], "miami": [25.7617, -80.1918],
            "cleveland": [41.4993, -81.6944], "kansas city": [39.0997, -94.5786], "raleigh": [35.7796, -78.6382],
            "detroit": [42.3314, -83.0458], "minneapolis": [44.9778, -93.2650], "tampa": [27.9506, -82.4572],
            "toronto": [43.6532, -79.3832], "montreal": [45.5017, -73.5673], "vancouver": [49.2827, -123.1207],
            "calgary": [51.0447, -114.0719], "edmonton": [53.5461, -113.4938], "ottawa": [45.4215, -75.6972],
            "winnipeg": [49.8951, -97.1384], "salt lake city": [40.7608, -111.8910], "sacramento": [38.5816, -121.4944],
            "orlando": [28.5383, -81.3792], "st louis": [38.6270, -90.1994], "pittsburgh": [40.4406, -79.9959],
            "cincinnati": [39.1031, -84.5120], "buffalo": [42.8864, -78.8784], "new orleans": [29.9511, -90.0715],
            "green bay": [44.5133, -88.0133],
            
            // Australia
            "sydney": [-33.8688, 151.2093], "melbourne": [-37.8136, 144.9631], "brisbane": [-27.4698, 153.0251],
            "perth": [-31.9505, 115.8605], "adelaide": [-34.9285, 138.6007], "gold coast": [-28.0167, 153.4000],
            "newcastle": [-32.9283, 151.7817], "canberra": [-35.2809, 149.1300], "geelong": [-38.1499, 144.3617],
            "hobart": [-42.8821, 147.3272], "fremantle": [-32.0569, 115.7439], "wollongong": [-34.4278, 150.8931],
            "west coast": [-31.9505, 115.8605], "hawthorn": [-37.8136, 144.9631], "essendon": [-37.8136, 144.9631],
            "collingwood": [-37.8136, 144.9631], "richmond": [-37.8136, 144.9631], "carlton": [-37.8136, 144.9631],
            "north melbourne": [-37.8136, 144.9631], "western bulldogs": [-37.8136, 144.9631], "st kilda": [-37.8136, 144.9631],
            "port adelaide": [-34.9285, 138.6007], "gws giants": [-33.8688, 151.2093], "sydney swans": [-33.8688, 151.2093],
            "brisbane lions": [-27.4698, 153.0251], "gold coast suns": [-28.0167, 153.4000],
            
            // Japan, Korea, China
            "tokyo": [35.6762, 139.6503], "osaka": [34.6937, 135.5023], "yokohama": [35.4437, 139.6380],
            "nagoya": [35.1815, 136.9066], "sapporo": [43.0618, 141.3545], "kobe": [34.6901, 135.1956],
            "fukuoka": [33.5904, 130.4017], "kawasaki": [35.5309, 139.7030], "hiroshima": [34.3853, 132.4553],
            "sendai": [38.2682, 140.8694], "kashima": [35.9667, 140.6333], "urawa": [35.8617, 139.6450],
            "seoul": [37.5665, 126.9780], "busan": [35.1796, 129.0756], "incheon": [37.4563, 126.7052],
            "daegu": [35.8714, 128.6014], "daejeon": [36.3504, 127.3845], "ulsan": [35.5384, 129.3114],
            "suwon": [37.2636, 127.0286], "jeonbuk": [35.8175, 127.1089], "pohang": [36.0190, 129.3435],
            "beijing": [39.9042, 116.4074], "shanghai": [31.2304, 121.4737], "guangzhou": [23.1291, 113.2644],
            "shenzhen": [22.5431, 114.0579], "tianjin": [39.3434, 117.3616], "chengdu": [30.5728, 104.0668],
            "wuhan": [30.5928, 114.3055], "hangzhou": [30.2741, 120.1551], "nanjing": [32.0603, 118.7969],
            "xian": [34.3416, 108.9398], "dalian": [38.9140, 121.6147], "shandong": [36.6683, 116.9972],
            
            // India
            "mumbai": [19.0760, 72.8777], "delhi": [28.7041, 77.1025], "bangalore": [12.9716, 77.5946],
            "hyderabad": [17.3850, 78.4867], "chennai": [13.0827, 80.2707], "kolkata": [22.5726, 88.3639],
            "pune": [18.5204, 73.8567], "ahmedabad": [23.0225, 72.5714], "jaipur": [26.9124, 75.7873],
            "lucknow": [26.8467, 80.9462], "kanpur": [26.4499, 80.3319], "nagpur": [21.1458, 79.0882],
            "kochi": [9.9312, 76.2673], "goa": [15.2993, 74.1240], "guwahati": [26.1445, 91.7362],
            "kerala": [9.9312, 76.2673], "mohun bagan": [22.5726, 88.3639], "east bengal": [22.5726, 88.3639],
            "atk": [22.5726, 88.3639], "bengaluru fc": [12.9716, 77.5946], "chennaiyin": [13.0827, 80.2707],
            "fc goa": [15.2993, 74.1240], "jamshedpur": [22.8046, 86.2029], "odisha": [20.2961, 85.8245],
            "northeast united": [26.1445, 91.7362], "mumbai city": [19.0760, 72.8777]
        };

        // Country centroids as last resort
        const COUNTRY_COORDS = {
            "england": [52.3555, -1.1743], "spain": [40.4637, -3.7492], "germany": [51.1657, 10.4515],
            "italy": [41.8719, 12.5674], "france": [46.2276, 2.2137], "netherlands": [52.1326, 5.2913],
            "portugal": [39.3999, -8.2245], "belgium": [50.5039, 4.4699], "scotland": [56.4907, -4.2026],
            "turkey": [38.9637, 35.2433], "greece": [39.0742, 21.8243], "austria": [47.5162, 14.5501],
            "usa": [37.0902, -95.7129], "brazil": [-14.2350, -51.9253], "argentina": [-38.4161, -63.6167],
            "australia": [-25.2744, 133.7751], "japan": [36.2048, 138.2529], "china": [35.8617, 104.1954],
            "india": [20.5937, 78.9629], "south korea": [35.9078, 127.7669], "mexico": [23.6345, -102.5528],
            "colombia": [4.5709, -74.2973], "peru": [-9.1900, -75.0152], "chile": [-35.6751, -71.5430]
        };

        // ============================================================================
        // GET COORDINATES FOR MATCH (IMPROVED)
        // ============================================================================
        function getMatchCoordinates(match) {
            const homeTeam = (match.home || match.team1 || '').toLowerCase();
            const awayTeam = (match.away || match.team2 || '').toLowerCase();
            const competition = (match.competition || '').toLowerCase();
            const country = (match.country || '').toLowerCase();

            // 1. Try exact team mapping to stadium
            for (const [team, stadium] of Object.entries(TEAM_LOCATIONS)) {
                if (homeTeam.includes(team.toLowerCase())) {
                    const coords = STADIUMS[stadium];
                    if (coords) return coords;
                }
            }

            // 2. Try city name extraction from team name
            for (const [city, coords] of Object.entries(CITY_COORDS)) {
                if (homeTeam.includes(city) || homeTeam.startsWith(city.split(' ')[0])) {
                    return coords;
                }
            }
            
            // 3. Try partial city match (team name contains city)
            const teamWords = homeTeam.split(/[\s\-]+/);
            for (const word of teamWords) {
                if (word.length >= 4 && CITY_COORDS[word]) {
                    return CITY_COORDS[word];
                }
            }

            // 4. Use country from league config or competition name
            const leagueCountry = getCountryFromCompetition(competition);
            if (leagueCountry && COUNTRY_COORDS[leagueCountry]) {
                const base = COUNTRY_COORDS[leagueCountry];
                // Add small deterministic offset based on team name hash
                const hash = hashString(homeTeam);
                const latOffset = ((hash % 100) - 50) / 100 * 3;
                const lonOffset = (((hash >> 8) % 100) - 50) / 100 * 4;
                return [base[0] + latOffset, base[1] + lonOffset];
            }

            // 5. Fallback to Europe center (not random ocean)
            return [48.0, 10.0]; // Central Europe
        }

        function getCountryFromCompetition(competition) {
            const comp = competition.toLowerCase();
            if (comp.includes('english') || comp.includes('premier') || comp.includes('efl') || comp.includes('fa cup')) return 'england';
            if (comp.includes('spanish') || comp.includes('la liga') || comp.includes('copa del rey')) return 'spain';
            if (comp.includes('german') || comp.includes('bundesliga') || comp.includes('dfb')) return 'germany';
            if (comp.includes('italian') || comp.includes('serie') || comp.includes('coppa')) return 'italy';
            if (comp.includes('french') || comp.includes('ligue')) return 'france';
            if (comp.includes('dutch') || comp.includes('eredivisie')) return 'netherlands';
            if (comp.includes('portuguese') || comp.includes('liga portugal')) return 'portugal';
            if (comp.includes('belgian') || comp.includes('pro league')) return 'belgium';
            if (comp.includes('scottish')) return 'scotland';
            if (comp.includes('turkish') || comp.includes('s√ºper lig')) return 'turkey';
            if (comp.includes('greek')) return 'greece';
            if (comp.includes('austrian')) return 'austria';
            if (comp.includes('nba') || comp.includes('nfl') || comp.includes('mlb') || comp.includes('nhl') || comp.includes('mls')) return 'usa';
            if (comp.includes('brazil') || comp.includes('s√©rie')) return 'brazil';
            if (comp.includes('argentin')) return 'argentina';
            if (comp.includes('j-league') || comp.includes('japan')) return 'japan';
            if (comp.includes('a-league') || comp.includes('afl') || comp.includes('australia')) return 'australia';
            if (comp.includes('indian') || comp.includes('isl')) return 'india';
            if (comp.includes('liga mx') || comp.includes('mexico')) return 'mexico';
            if (comp.includes('k-league') || comp.includes('korea')) return 'south korea';
            if (comp.includes('chinese') || comp.includes('super league') && comp.includes('chin')) return 'china';
            return null;
        }

        // ============================================================================
        // FETCH MATCHES - With caching and parallel loading
        // ============================================================================
        async function fetchAllMatches() {
            console.log('Fetching matches...');
            allMatches = [];
            
            // Check caches first
            const cachedOpenFootball = CACHE.get(CACHE.KEYS.OPENFOOTBALL);
            const cachedESPN = CACHE.get(CACHE.KEYS.ESPN);
            const cacheAge = CACHE.getAge(CACHE.KEYS.OPENFOOTBALL);
            
            // If we have valid cache, use it immediately (instant load!)
            if (cachedOpenFootball && cachedESPN) {
                console.log(`Using cached data (${cacheAge}m old)`);
                allMatches = [...cachedOpenFootball, ...cachedESPN];
                updateUI();
                plotMatchesOnMap();
                updateLoadingStatus(`Loaded from cache (${cacheAge}m ago) ‚Ä¢ ${allMatches.length} matches`);
                
                // Background refresh if cache > 10 minutes old
                if (cacheAge > 10) {
                    setTimeout(() => refreshDataInBackground(), 100);
                }
                return;
            }
            
            // No cache - use TIERED LOADING for fast initial render
            updateLoadingStatus('Loading top leagues...');
            
            // PHASE 1: Load priority leagues only (5 soccer + NBA/NHL = 7 requests)
            const [priorityFootball, priorityESPN] = await Promise.all([
                fetchLeagues(CONFIG.PRIORITY_LEAGUES),
                fetchESPNLeagues(CONFIG.PRIORITY_ESPN)
            ]);
            
            allMatches = [...priorityFootball, ...priorityESPN];
            updateUI();
            plotMatchesOnMap();
            updateLoadingStatus(`${allMatches.length} matches (loading more...)`);
            
            // PHASE 2: Load secondary leagues in background (non-blocking)
            setTimeout(async () => {
                const [secondaryFootball, secondaryESPN] = await Promise.all([
                    fetchLeagues(CONFIG.SECONDARY_LEAGUES),
                    fetchESPNLeagues(CONFIG.SECONDARY_ESPN)
                ]);
                
                allMatches = [...priorityFootball, ...priorityESPN, ...secondaryFootball, ...secondaryESPN];
                
                // Cache the complete results
                CACHE.set(CACHE.KEYS.OPENFOOTBALL, [...priorityFootball, ...secondaryFootball]);
                CACHE.set(CACHE.KEYS.ESPN, [...priorityESPN, ...secondaryESPN]);
                
                updateUI();
                plotMatchesOnMap();
                updateLoadingStatus(`Loaded ${allMatches.length} matches`);
            }, 50);
        }
        
        // Background refresh without blocking UI
        async function refreshDataInBackground() {
            console.log('Background refresh...');
            const [openFootballMatches, espnMatches] = await Promise.all([
                fetchOpenFootballData(),
                fetchESPNData()
            ]);
            
            const newMatches = [...openFootballMatches, ...espnMatches];
            
            // Only update if we got data
            if (newMatches.length > 0) {
                allMatches = newMatches;
                CACHE.set(CACHE.KEYS.OPENFOOTBALL, openFootballMatches);
                CACHE.set(CACHE.KEYS.ESPN, espnMatches);
                updateUI();
                plotMatchesOnMap();
                console.log('Background refresh complete');
            }
        }
        
        // Update loading status in the header
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.opacity = '1';
                setTimeout(() => { statusEl.style.opacity = '0.6'; }, 2000);
            }
        }

        // ============================================================================
        // FETCH LEAGUES (configurable - for tiered loading)
        // ============================================================================
        async function fetchLeagues(leagueConfig) {
            const leagueKeys = Object.keys(leagueConfig);
            let matches = [];
            
            const fetchPromises = leagueKeys.map(async (leagueKey) => {
                const league = leagueConfig[leagueKey];
                try {
                    const url = `${CONFIG.OPENFOOTBALL_BASE}/${league.file}`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.matches && Array.isArray(data.matches)) {
                            return parseOpenFootballMatches(data.matches, leagueKey, league, data.name);
                        }
                    }
                } catch (e) {
                    console.warn(`Failed to fetch ${league.name}:`, e);
                }
                return [];
            });

            const results = await Promise.all(fetchPromises);
            results.forEach(m => { matches = matches.concat(m); });
            return processMatches(matches);
        }
        
        // Fetch ESPN leagues (configurable)
        async function fetchESPNLeagues(leagueConfig) {
            const leagueKeys = Object.keys(leagueConfig);
            let matches = [];
            
            const fetchPromises = leagueKeys.map(async (leagueKey) => {
                const league = leagueConfig[leagueKey];
                try {
                    const url = `${CONFIG.ESPN_API}/${league.sport}/${league.league}/scoreboard`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.events && Array.isArray(data.events)) {
                            return parseESPNEvents(data.events, leagueKey, league);
                        }
                    }
                } catch (e) {
                    console.warn(`Failed to fetch ESPN ${league.name}:`, e);
                }
                return [];
            });

            const results = await Promise.all(fetchPromises);
            results.forEach(m => { matches = matches.concat(m); });
            return matches;
        }
        
        // Process matches (filter, dedupe, sort)
        function processMatches(matches) {
            const now = new Date();
            const thirtyDaysLater = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            matches = matches.filter(m => {
                const matchDate = new Date(m.startTime);
                return matchDate >= now && matchDate <= thirtyDaysLater;
            });

            const seen = new Set();
            matches = matches.filter(m => {
                const key = `${m.home}-${m.away}-${m.startTime}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            matches.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            return matches;
        }

        // Legacy function for background refresh
        async function fetchOpenFootballData() {
            console.log('Fetching all OpenFootball leagues...');
            const allLeagues = { ...CONFIG.PRIORITY_LEAGUES, ...CONFIG.SECONDARY_LEAGUES };
            return fetchLeagues(allLeagues);
        }
        
        async function fetchESPNData() {
            console.log('Fetching all ESPN sports...');
            const allESPN = { ...CONFIG.PRIORITY_ESPN, ...CONFIG.SECONDARY_ESPN };
            return fetchESPNLeagues(allESPN);
        }

        // ============================================================================
        // PARSE ESPN EVENTS
        // ============================================================================
        function parseESPNEvents(events, leagueKey, leagueConfig) {
            return events.map(event => {
                const competition = event.competitions?.[0];
                const homeTeam = competition?.competitors?.find(c => c.homeAway === 'home');
                const awayTeam = competition?.competitors?.find(c => c.homeAway === 'away');
                
                if (!homeTeam || !awayTeam) return null;
                
                const home = homeTeam.team?.displayName || homeTeam.team?.name || 'Home';
                const away = awayTeam.team?.displayName || awayTeam.team?.name || 'Away';
                const venue = competition?.venue;
                
                const isLive = event.status?.type?.state === 'in';
                const isScheduled = event.status?.type?.state === 'pre';
                
                // Get coordinates
                const coords = getMatchCoordinates({
                    home,
                    away,
                    competition: leagueConfig.name,
                    venue: venue?.fullName,
                    city: venue?.address?.city,
                    country: leagueKey.includes('arg') || leagueKey.includes('brazil') ? 
                        (leagueKey.includes('arg') ? 'Argentina' : 'Brazil') : 'USA'
                });

                // Generate display odds
                const { homeOdds, drawOdds, awayOdds } = generateDisplayOdds(home, away, parseInt(event.id) || 0);

                return {
                    id: `espn-${event.id}`,
                    home,
                    away,
                    homeScore: homeTeam.score,
                    awayScore: awayTeam.score,
                    homeOdds,
                    awayOdds,
                    drawOdds: leagueConfig.sport === 'soccer' ? drawOdds : null,
                    homeLogo: homeTeam.team?.logo,
                    awayLogo: awayTeam.team?.logo,
                    competition: leagueConfig.name,
                    competitionKey: leagueKey,
                    venue: venue?.fullName,
                    city: venue?.address?.city,
                    startTime: event.date,
                    sport: leagueConfig.sport,
                    isLive,
                    status: isLive ? 'In Progress' : (isScheduled ? 'Scheduled' : event.status?.type?.description),
                    coords,
                    source: 'espn'
                };
            }).filter(Boolean);
        }

        // ============================================================================
        // PARSE OPENFOOTBALL MATCHES
        // ============================================================================
        function parseOpenFootballMatches(matches, leagueKey, leagueConfig, leagueName) {
            return matches
                .filter(match => match.team1 && match.team2)
                // Only include upcoming matches (no final score yet)
                .filter(match => !match.score || match.score.ft === undefined || match.score.ft === null)
                .map((match, idx) => {
                    const now = new Date();
                    const matchTime = match.time || '15:00';
                    const startTime = `${match.date}T${matchTime}:00`;
                    const matchDate = new Date(startTime);
                    
                    // Check if live
                    const timeDiff = (now - matchDate) / (1000 * 60);
                    const isLive = timeDiff >= 0 && timeDiff <= 120;
                    
                    // Clean team names
                    const home = cleanTeamName(match.team1);
                    const away = cleanTeamName(match.team2);
                    
                    // Get coordinates
                    const coords = getMatchCoordinates({
                        home,
                        away,
                        competition: leagueName || leagueConfig.name
                    });

                    // Generate display odds
                    const { homeOdds, drawOdds, awayOdds } = generateDisplayOdds(home, away, idx);

                    return {
                        id: `${leagueKey}-${match.date}-${idx}`,
                        home,
                        away,
                        homeScore: match.score?.ft?.[0] ?? null,
                        awayScore: match.score?.ft?.[1] ?? null,
                        homeOdds,
                        awayOdds,
                        drawOdds,
                        competition: leagueName || leagueConfig.name,
                        competitionKey: leagueKey,
                        round: match.round,
                        startTime,
                        sport: 'Soccer',
                        isLive,
                        status: isLive ? 'In Progress' : 'Scheduled',
                        coords
                    };
                });
        }

        // ============================================================================
        // CLEAN TEAM NAME (remove FC, AFC, etc.)
        // ============================================================================
        function cleanTeamName(name) {
            return name
                .replace(/ FC$/i, '')
                .replace(/^FC /i, '')
                .replace(/ AFC$/i, '')
                .replace(/^AFC /i, '')
                .trim();
        }

        // ============================================================================
        // GENERATE DISPLAY ODDS (cosmetic)
        // ============================================================================
        function generateDisplayOdds(home, away, seed) {
            // Create deterministic "random" based on team names
            const hashStr = home + away + seed;
            let hash = 0;
            for (let i = 0; i < hashStr.length; i++) {
                hash = ((hash << 5) - hash) + hashStr.charCodeAt(i);
                hash |= 0;
            }
            
            const rand = (min, max, offset = 0) => {
                const x = Math.abs(Math.sin((hash + offset) * 9999) * 10000);
                return min + (x - Math.floor(x)) * (max - min);
            };
            
            // Generate balanced odds that sum to reasonable margin
            const homeOdds = rand(1.4, 3.5, 1).toFixed(2);
            const awayOdds = rand(1.6, 4.0, 2).toFixed(2);
            const drawOdds = rand(3.0, 4.2, 3).toFixed(2);
            
            return {
                homeOdds: parseFloat(homeOdds),
                drawOdds: parseFloat(drawOdds),
                awayOdds: parseFloat(awayOdds)
            };
        }

        // ============================================================================
        // PLOT MATCHES ON MAP
        // ============================================================================
        function plotMatchesOnMap() {
            // If map not loaded yet, mark data as pending
            if (!mapLoaded || !map) {
                pendingMatches = true;
                console.log('Data ready, waiting for map...');
                return;
            }
            
            // Remove existing markers
            markers.forEach(m => m.remove());
            markers = [];

            const filteredMatches = filterMatches();

            filteredMatches.forEach(match => {
                if (!match.coords) return;

                const el = document.createElement('div');
                el.className = `map-marker ${match.isLive ? 'live' : 'upcoming'}`;
                
                const marker = new maplibregl.Marker({ element: el })
                    .setLngLat([match.coords[1], match.coords[0]])
                    .setPopup(createPopup(match))
                    .addTo(map);

                markers.push(marker);
            });

            document.getElementById('map-total').textContent = filteredMatches.length;
            document.getElementById('map-live').textContent = filteredMatches.filter(m => m.isLive).length;
        }

        // ============================================================================
        // INDOOR/OUTDOOR DETECTION
        // ============================================================================
        const INDOOR_SPORTS = ['nba', 'nhl', 'basketball', 'ice hockey', 'hockey', 'volleyball', 'handball', 'futsal'];
        const INDOOR_VENUES = [
            'arena', 'center', 'centre', 'dome', 'garden', 'forum', 'coliseum', 'fieldhouse', 
            'pavilion', 'palace', 'hall', 'indoor', 'o2', 'msg', 'staples', 'barclays',
            'td garden', 'united center', 'madison square', 'crypto.com', 'chase center'
        ];
        
        function isIndoorEvent(match) {
            const sport = (match.sport || '').toLowerCase();
            const venue = (match.venue || '').toLowerCase();
            const competition = (match.competition || '').toLowerCase();
            const key = (match.competitionKey || '').toLowerCase();
            
            // Check if sport is inherently indoor
            if (INDOOR_SPORTS.some(s => sport.includes(s) || key.includes(s) || competition.includes(s))) {
                return true;
            }
            
            // Check venue name for indoor indicators
            if (INDOOR_VENUES.some(v => venue.includes(v))) {
                return true;
            }
            
            // NBA, NHL are always indoor
            if (key === 'nba' || key === 'nhl') {
                return true;
            }
            
            return false;
        }

        // ============================================================================
        // WEATHER CACHE
        // ============================================================================
        const weatherCache = new Map();

        // ============================================================================
        // FETCH WEATHER FOR COORDINATES
        // ============================================================================
        async function fetchWeather(lat, lon, matchDate) {
            const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)},${matchDate}`;
            if (weatherCache.has(cacheKey)) return weatherCache.get(cacheKey);
            
            try {
                const url = `${CONFIG.WEATHER_API}?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&timezone=auto&start_date=${matchDate}&end_date=${matchDate}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    const weather = {
                        tempMax: data.daily?.temperature_2m_max?.[0],
                        tempMin: data.daily?.temperature_2m_min?.[0],
                        precipProb: data.daily?.precipitation_probability_max?.[0],
                        windSpeed: data.daily?.windspeed_10m_max?.[0],
                        code: data.daily?.weathercode?.[0]
                    };
                    weatherCache.set(cacheKey, weather);
                    return weather;
                }
            } catch (e) {
                console.warn('Weather fetch failed:', e);
            }
            return null;
        }

        // ============================================================================
        // GET WEATHER EMOJI FROM CODE
        // ============================================================================
        function getWeatherEmoji(code) {
            if (code === undefined || code === null) return 'üå§Ô∏è';
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return '‚ùÑÔ∏è';
            if (code >= 95) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        // ============================================================================
        // GENERATE MATCH INTEL (contextual insights)
        // ============================================================================
        function generateMatchIntel(match) {
            const intel = [];
            const hash = hashString(match.home + match.away);
            
            // Head-to-head narrative
            const h2hOutcomes = ['dominated', 'edged', 'struggled against', 'had close battles with'];
            const h2hIdx = hash % h2hOutcomes.length;
            intel.push({
                type: 'h2h',
                icon: 'üìä',
                text: `${match.home} have ${h2hOutcomes[h2hIdx]} ${match.away} in recent meetings`
            });
            
            // Form insights
            const forms = ['WWWDL', 'WDWLW', 'LLDWW', 'DWWWD', 'WLWDW'];
            const homeForm = forms[hash % forms.length];
            const awayForm = forms[(hash + 1) % forms.length];
            intel.push({
                type: 'form',
                icon: 'üìà',
                text: `Home form: ${homeForm} | Away form: ${awayForm}`
            });
            
            // Injury news (generated based on team)
            const injuryTemplates = [
                { status: 'üü¢', text: 'Full squad available, no major concerns' },
                { status: 'üü°', text: 'Key midfielder doubtful (hamstring)' },
                { status: 'üü°', text: 'Starting striker questionable (knock)' },
                { status: 'üî¥', text: 'Captain OUT (suspended)' },
                { status: 'üü¢', text: 'Star player back from injury, expected to start' }
            ];
            const homeInjury = injuryTemplates[hash % injuryTemplates.length];
            const awayInjury = injuryTemplates[(hash + 2) % injuryTemplates.length];
            intel.push({
                type: 'injury',
                icon: 'üè•',
                text: `${match.home}: ${homeInjury.text}`
            });
            intel.push({
                type: 'injury',
                icon: 'üè•',
                text: `${match.away}: ${awayInjury.text}`
            });
            
            // Betting angle
            const angles = [
                'Sharp money on the under - defense-first managers',
                'Line moving toward home side - local intel?',
                'BTTS trending - both teams score freely',
                'Cards market interesting - strict referee assigned',
                'Over 2.5 value - attacking lineups expected'
            ];
            intel.push({
                type: 'angle',
                icon: 'üí°',
                text: angles[(hash + 3) % angles.length]
            });
            
            return intel;
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        // ============================================================================
        // CREATE POPUP FOR MARKER (ENRICHED)
        // ============================================================================
        function createPopup(match) {
            const statusClass = match.isLive ? 'live' : 'upcoming';
            const matchDate = new Date(match.startTime);
            const dateStr = matchDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            const timeStr = formatTime(match.startTime);
            const intel = generateMatchIntel(match);
            
            // Create popup with loading state for weather
            const popupId = `popup-${match.id}`;
            
            const html = `
                <div class="map-popup rich-popup" id="${popupId}">
                    <div class="popup-header">
                        <span class="popup-league">${getLeagueShortName(match.competitionKey, match.competition)}</span>
                        <span class="popup-status ${statusClass}">${match.isLive ? 'üî¥ LIVE' : dateStr}</span>
                    </div>
                    
                    <div class="popup-matchup">
                        <div class="popup-team home">
                            <span class="team-name">${match.home}</span>
                            <span class="team-odds">${formatOdds(match.homeOdds)}</span>
                        </div>
                        <div class="popup-vs">
                            <span class="vs-text">vs</span>
                            <span class="vs-time">${timeStr}</span>
                        </div>
                        <div class="popup-team away">
                            <span class="team-name">${match.away}</span>
                            <span class="team-odds">${formatOdds(match.awayOdds)}</span>
                        </div>
                    </div>
                    
                    ${match.drawOdds ? `<div class="popup-draw">Draw: ${formatOdds(match.drawOdds)}</div>` : ''}
                    
                    <div class="popup-weather" id="weather-${popupId}">
                        ${isIndoorEvent(match) 
                            ? '<div class="weather-indoor">üèüÔ∏è <strong>Indoor Event</strong> ‚Äî weather not a factor</div>'
                            : '<span class="weather-loading">‚è≥ Loading weather...</span>'
                        }
                    </div>
                    
                    <div class="popup-intel">
                        <div class="intel-title">üì° Match Intel</div>
                        ${intel.map(i => `
                            <div class="intel-item ${i.type}">
                                <span class="intel-icon">${i.icon}</span>
                                <span class="intel-text">${i.text}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="popup-footer">
                        <span class="popup-round">${match.round || ''}</span>
                        <span class="popup-competition">${match.competition}</span>
                    </div>
                </div>
            `;

            const popup = new maplibregl.Popup({ offset: 15, maxWidth: '360px' }).setHTML(html);
            
            // Fetch weather when popup opens (skip for indoor events)
            popup.on('open', async () => {
                if (isIndoorEvent(match)) return; // Skip weather for indoor events
                
                if (match.coords) {
                    const matchDateStr = matchDate.toISOString().split('T')[0];
                    const weather = await fetchWeather(match.coords[0], match.coords[1], matchDateStr);
                    const weatherEl = document.getElementById(`weather-${popupId}`);
                    if (weatherEl && weather) {
                        const emoji = getWeatherEmoji(weather.code);
                        const temp = Math.round((weather.tempMax + weather.tempMin) / 2);
                        const wind = Math.round(weather.windSpeed);
                        const rain = weather.precipProb;
                        
                        let weatherClass = 'good';
                        let weatherNote = '';
                        if (rain > 60) { weatherClass = 'bad'; weatherNote = '‚òî Wet conditions - consider unders'; }
                        else if (wind > 30) { weatherClass = 'caution'; weatherNote = 'üí® Windy - aerial balls unreliable'; }
                        else if (temp < 5) { weatherClass = 'caution'; weatherNote = 'ü•∂ Cold - physical game expected'; }
                        else if (temp > 30) { weatherClass = 'caution'; weatherNote = 'ü•µ Hot - pace may drop late'; }
                        
                        weatherEl.innerHTML = `
                            <div class="weather-data ${weatherClass}">
                                <span class="weather-main">${emoji} ${temp}¬∞C</span>
                                <span class="weather-detail">üí® ${wind} km/h</span>
                                <span class="weather-detail">üåßÔ∏è ${rain}%</span>
                            </div>
                            ${weatherNote ? `<div class="weather-note">${weatherNote}</div>` : ''}
                        `;
                    } else if (weatherEl) {
                        weatherEl.innerHTML = '<span class="weather-unavailable">Weather data unavailable</span>';
                    }
                }
            });

            return popup;
        }

        // ============================================================================
        // FILTER MATCHES BY LEAGUE
        // ============================================================================
        function filterMatches() {
            let filtered = [...allMatches];

            if (activeLeague !== 'all') {
                const tier2Keys = ['championship', 'league-one', 'league-two', 'la-liga-2', 'bundesliga-2', 'serie-b', 'ligue-2'];
                const americasKeys = ['mls', 'liga-mx', 'arg-liga', 'brazil-serie-a'];
                const asiaKeys = ['j-league', 'india-isl', 'saudi-pro'];
                const euroOtherKeys = ['eredivisie', 'primeira-liga', 'belgian-pro', 'scottish-prem', 'super-lig', 'super-league-gr', 'bundesliga-at'];
                
                filtered = filtered.filter(m => {
                    const key = m.competitionKey || '';
                    
                    switch (activeLeague) {
                        case 'premier-league': return key === 'premier-league';
                        case 'la-liga': return key === 'la-liga' || key === 'la-liga-2';
                        case 'bundesliga': return key === 'bundesliga' || key === 'bundesliga-2';
                        case 'serie-a': return key === 'serie-a' || key === 'serie-b';
                        case 'ligue-1': return key === 'ligue-1' || key === 'ligue-2';
                        case 'nba': return key === 'nba';
                        case 'nhl': return key === 'nhl';
                        case 'afl': return key === 'afl';
                        case 'americas': return americasKeys.includes(key);
                        case 'asia': return asiaKeys.includes(key);
                        case 'europe-other': return euroOtherKeys.includes(key);
                        case 'tier2': return tier2Keys.includes(key);
                        default: return true;
                    }
                });
            }

            // Filter by layer toggles
            if (!activeLayers.live) {
                filtered = filtered.filter(m => !m.isLive);
            }
            if (!activeLayers.upcoming) {
                filtered = filtered.filter(m => m.isLive);
            }

            return filtered;
        }

        // ============================================================================
        // UPDATE UI
        // ============================================================================
        function updateUI() {
            const now = new Date();
            const liveCount = allMatches.filter(m => m.isLive).length;
            const todayCount = allMatches.filter(m => {
                const matchDate = new Date(m.startTime);
                return matchDate.toDateString() === now.toDateString();
            }).length;

            // Helper to count matches for a league
            const countForLeague = (pattern) => {
                return allMatches.filter(m => {
                    const key = (m.competitionKey || '').toLowerCase();
                    const name = (m.competition || '').toLowerCase();
                    if (typeof pattern === 'string') {
                        return key === pattern || name.includes(pattern.replace('-', ' '));
                    }
                    return pattern.test(key) || pattern.test(name);
                }).length;
            };

            // Update status bar
            document.getElementById('status-live').textContent = liveCount;
            document.getElementById('status-today').textContent = todayCount;
            document.getElementById('status-upcoming').textContent = allMatches.length;
            document.getElementById('status-leagues').textContent = new Set(allMatches.map(m => m.competition)).size;
            document.getElementById('status-movements').textContent = Math.floor(Math.random() * 15) + 5;
            document.getElementById('status-update').textContent = formatTime(now.toISOString());

            // Update counts by league key
            const countByKey = (key) => allMatches.filter(m => m.competitionKey === key).length;
            const countByKeys = (keys) => allMatches.filter(m => keys.includes(m.competitionKey)).length;
            
            document.getElementById('count-all').textContent = allMatches.length;
            document.getElementById('count-pl').textContent = countByKey('premier-league');
            document.getElementById('count-ll').textContent = countByKeys(['la-liga', 'la-liga-2']);
            document.getElementById('count-bl').textContent = countByKeys(['bundesliga', 'bundesliga-2']);
            document.getElementById('count-sa').textContent = countByKeys(['serie-a', 'serie-b']);
            document.getElementById('count-l1').textContent = countByKeys(['ligue-1', 'ligue-2']);
            document.getElementById('count-nba').textContent = countByKey('nba');
            document.getElementById('count-nhl').textContent = countByKey('nhl');
            document.getElementById('count-afl').textContent = countByKey('afl');
            // Americas (MLS, Liga MX, Argentina, Brazil)
            const americasKeys = ['mls', 'liga-mx', 'arg-liga', 'brazil-serie-a'];
            document.getElementById('count-am').textContent = countByKeys(americasKeys);
            // Asia (J-League, India ISL, Saudi)
            const asiaKeys = ['j-league', 'india-isl', 'saudi-pro'];
            document.getElementById('count-asia').textContent = countByKeys(asiaKeys);
            // Europe Other (Netherlands, Portugal, Belgium, Scotland, Turkey, Greece, Austria)
            const euroOtherKeys = ['eredivisie', 'primeira-liga', 'belgian-pro', 'scottish-prem', 'super-lig', 'super-league-gr', 'bundesliga-at'];
            document.getElementById('count-eur').textContent = countByKeys(euroOtherKeys);
            // Second tiers
            const tier2Keys = ['championship', 'league-one', 'league-two', 'la-liga-2', 'bundesliga-2', 'serie-b', 'ligue-2'];
            document.getElementById('count-t2').textContent = countByKeys(tier2Keys);

            // Update market summary
            document.getElementById('market-live').textContent = liveCount;
            document.getElementById('market-today').textContent = todayCount;
            document.getElementById('market-leagues').textContent = new Set(allMatches.map(m => m.competition)).size;
            document.getElementById('market-volume').textContent = allMatches.length * 3;

            // Render panels
            renderIntelFeed();
            renderMovementFeed();
            renderTakesFeed();
            renderLeagueStatus();
            renderMatchGrid();
        }

        // ============================================================================
        // RENDER INTEL FEED
        // ============================================================================
        function renderIntelFeed() {
            const intelItems = [
                { type: 'injury', icon: 'üè•', text: 'Liverpool: Salah questionable (hamstring), N√∫√±ez probable. Line holding steady.', source: 'Club Official', time: '12m ago' },
                { type: 'movement', icon: 'üìà', text: 'Man City ML moved from 1.65 ‚Üí 1.55 in last 2 hours. Sharp action detected.', source: 'Odds Movement', time: '18m ago' },
                { type: 'value', icon: 'üíé', text: 'Bayern Munich vs Dortmund: Over 2.5 at 1.85 showing positive expected value.', source: 'Model Alert', time: '25m ago' },
                { type: 'weather', icon: 'üåßÔ∏è', text: 'Newcastle: Heavy rain forecast, 15mph winds. Consider under totals.', source: 'Weather Intel', time: '32m ago' },
                { type: 'injury', icon: 'üè•', text: 'Chelsea: Palmer returns to training. Expected to start vs Arsenal.', source: 'Training Report', time: '45m ago' },
                { type: 'movement', icon: 'üìà', text: 'Arsenal -1.5 spread steaming from -110 to -125. Volume spike.', source: 'Line Alert', time: '1h ago' }
            ];

            document.getElementById('intel-feed').innerHTML = intelItems.map(item => `
                <div class="intel-item ${item.type}">
                    <div class="intel-header">
                        <span class="intel-type">${item.icon} ${item.type.toUpperCase()}</span>
                        <span class="intel-time">${item.time}</span>
                    </div>
                    <div class="intel-content">${item.text}</div>
                    <div class="intel-source">via ${item.source}</div>
                </div>
            `).join('');
        }

        // ============================================================================
        // RENDER LINE MOVEMENT FEED
        // ============================================================================
        function renderMovementFeed() {
            const movements = [
                { teams: 'Chelsea vs Arsenal', league: 'Premier League', direction: 'down', from: '2.10', to: '1.95', time: '2h' },
                { teams: 'Real Madrid vs Barcelona', league: 'La Liga', direction: 'up', from: '1.85', to: '2.05', time: '3h' },
                { teams: 'Bayern vs Dortmund', league: 'Bundesliga', direction: 'down', from: '1.70', to: '1.58', time: '4h' },
                { teams: 'Lakers vs Celtics', league: 'NBA', direction: 'up', from: '1.90', to: '2.15', time: '1h' },
                { teams: 'Inter vs Juventus', league: 'Serie A', direction: 'down', from: '2.25', to: '2.05', time: '5h' }
            ];

            document.getElementById('movement-feed').innerHTML = movements.map(m => `
                <div class="movement-item">
                    <div class="movement-match">
                        <div class="movement-teams">${m.teams}</div>
                        <div class="movement-league">${m.league}</div>
                    </div>
                    <div class="movement-change">
                        <span class="movement-arrow ${m.direction}">${m.direction === 'up' ? '‚Üë' : '‚Üì'}</span>
                        <div class="movement-odds">${m.from} ‚Üí ${m.to}</div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // RENDER TWITTER/X TAKES FEED
        // ============================================================================
        function renderTakesFeed() {
            const takes = [
                {
                    user: 'BettingPros',
                    handle: '@BettingPros',
                    avatar: 'üìä',
                    content: 'Liverpool missing 3 starters, line hasn\'t moved. Market inefficiency? Value on draw +280.',
                    likes: 1247,
                    retweets: 312,
                    time: '28m'
                },
                {
                    user: 'SharpsReport',
                    handle: '@SharpsReport',
                    avatar: 'üéØ',
                    content: 'Sharp money all over Man City -1.5. Public on United but wiseguys loading City.',
                    likes: 892,
                    retweets: 245,
                    time: '45m'
                },
                {
                    user: 'WeatherBets',
                    handle: '@WeatherBets',
                    avatar: 'üåßÔ∏è',
                    content: 'Rain + wind at St James\' Park. Under 2.5 at 1.95 is the play. Newcastle unders 5-1 in wet conditions.',
                    likes: 634,
                    retweets: 178,
                    time: '1h'
                },
                {
                    user: 'InjuryInsider',
                    handle: '@InjuryInsider',
                    avatar: 'üè•',
                    content: 'Haaland GTD but expected to play limited minutes. Consider Foden anytime scorer +185.',
                    likes: 1089,
                    retweets: 298,
                    time: '2h'
                },
                {
                    user: 'ModelMaster',
                    handle: '@ModelMaster',
                    avatar: 'ü§ñ',
                    content: 'Our model has Bayern -1.5 at 68% but line implies 55%. Clear edge. Hammering it.',
                    likes: 2156,
                    retweets: 567,
                    time: '3h'
                }
            ];

            document.getElementById('takes-feed').innerHTML = takes.map(t => `
                <div class="take-item">
                    <div class="take-header">
                        <div class="take-avatar">${t.avatar}</div>
                        <div>
                            <div class="take-user">${t.user}</div>
                            <div class="take-handle">${t.handle} ¬∑ ${t.time}</div>
                        </div>
                    </div>
                    <div class="take-content">${t.content}</div>
                    <div class="take-meta">
                        <span class="take-stat">üí¨ ${Math.floor(t.likes / 10)}</span>
                        <span class="take-stat">üîÑ ${t.retweets}</span>
                        <span class="take-stat">‚ù§Ô∏è ${t.likes}</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // RENDER LEAGUE STATUS
        // ============================================================================
        function renderLeagueStatus() {
            // Group matches by competition
            const leagueCounts = {};
            allMatches.forEach(m => {
                const comp = m.competition || 'Unknown';
                leagueCounts[comp] = (leagueCounts[comp] || 0) + 1;
            });

            // Sort by count and take top leagues
            const topLeagues = Object.entries(leagueCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12)
                .map(([name, count]) => {
                    const hasLive = allMatches.some(m => m.competition === name && m.isLive);
                    const flag = getLeagueFlag(name);
                    return {
                        flag,
                        name: name.length > 25 ? name.substring(0, 22) + '...' : name,
                        status: hasLive ? 'active' : 'upcoming',
                        matches: count
                    };
                });

            document.getElementById('league-status').innerHTML = topLeagues.map(l => `
                <div class="league-status-item">
                    <div class="league-status-info">
                        <span class="league-status-flag">${l.flag}</span>
                        <span class="league-status-name">${l.name} (${l.matches})</span>
                    </div>
                    <span class="league-status-badge ${l.status}">${l.status.toUpperCase()}</span>
                </div>
            `).join('');
        }

        // Get flag emoji for league
        function getLeagueFlag(leagueName) {
            const name = leagueName.toLowerCase();
            if (name.includes('premier') || name.includes('english') || name.includes('england')) return 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø';
            if (name.includes('la liga') || name.includes('spain') || name.includes('primera')) return 'üá™üá∏';
            if (name.includes('bundesliga') || name.includes('german')) return 'üá©üá™';
            if (name.includes('serie a') || name.includes('italy') || name.includes('italian')) return 'üáÆüáπ';
            if (name.includes('ligue 1') || name.includes('french') || name.includes('france')) return 'üá´üá∑';
            if (name.includes('champions league')) return 'üèÜ';
            if (name.includes('europa league')) return 'üèÜ';
            if (name.includes('nba')) return 'üèÄ';
            if (name.includes('nfl') || name.includes('ncaa')) return 'üèà';
            if (name.includes('nhl')) return 'üèí';
            if (name.includes('mlb')) return '‚öæ';
            if (name.includes('mls') || name.includes('major league soccer')) return 'üá∫üá∏';
            if (name.includes('eredivisie') || name.includes('dutch') || name.includes('netherlands')) return 'üá≥üá±';
            if (name.includes('portugal') || name.includes('liga nos')) return 'üáµüáπ';
            if (name.includes('brazil') || name.includes('brasileir√£o')) return 'üáßüá∑';
            if (name.includes('mexico') || name.includes('liga mx')) return 'üá≤üáΩ';
            if (name.includes('argentina')) return 'üá¶üá∑';
            if (name.includes('scotland') || name.includes('scottish')) return 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø';
            if (name.includes('belgium')) return 'üáßüá™';
            if (name.includes('turkey') || name.includes('turkish')) return 'üáπüá∑';
            if (name.includes('russia')) return 'üá∑üá∫';
            if (name.includes('australia')) return 'üá¶üá∫';
            if (name.includes('japan') || name.includes('j-league')) return 'üáØüáµ';
            if (name.includes('china')) return 'üá®üá≥';
            if (name.includes('cfl') || name.includes('canad')) return 'üá®üá¶';
            return '‚öΩ';
        }

        // ============================================================================
        // RENDER MATCH GRID
        // ============================================================================
        function renderMatchGrid() {
            const filtered = filterMatches();
            
            document.getElementById('match-count-label').textContent = `${filtered.length} matches`;

            if (filtered.length === 0) {
                document.getElementById('match-grid').innerHTML = `
                    <div class="loading-container">
                        <div>No matches found for selected filters</div>
                    </div>
                `;
                return;
            }

            // Sort: live first, then by start time
            filtered.sort((a, b) => {
                if (a.isLive && !b.isLive) return -1;
                if (!a.isLive && b.isLive) return 1;
                return new Date(a.startTime) - new Date(b.startTime);
            });

            document.getElementById('match-grid').innerHTML = filtered.slice(0, 50).map(match => {
                const hasMovement = Math.random() > 0.7;
                const hasInjury = Math.random() > 0.8;
                const hasWeather = Math.random() > 0.85;
                const hasValue = Math.random() > 0.9;
                
                // Format date if not today
                const matchDate = new Date(match.startTime);
                const today = new Date();
                const isToday = matchDate.toDateString() === today.toDateString();
                const dateStr = isToday ? '' : matchDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' }) + ' ‚Ä¢ ';

                return `
                    <div class="match-card ${match.isLive ? 'live' : ''}">
                        <div class="match-card-header">
                            <span class="match-league">${getLeagueShortName(match.competitionKey, match.competition)}</span>
                            ${match.isLive 
                                ? '<span class="match-status-badge live">LIVE</span>'
                                : `<span class="match-time">${dateStr}${formatTime(match.startTime)}</span>`
                            }
                        </div>
                        <div class="match-teams">
                            <div class="match-team-row">
                                <span class="match-team-name">${match.home}</span>
                                <span class="match-odds ${hasMovement ? (Math.random() > 0.5 ? 'up' : 'down') : ''}">${formatOdds(match.homeOdds)}</span>
                            </div>
                            <div class="match-team-row">
                                <span class="match-team-name">${match.away}</span>
                                <span class="match-odds">${formatOdds(match.awayOdds)}</span>
                            </div>
                        </div>
                        ${match.drawOdds ? `<div style="text-align:center;margin-bottom:0.5rem;"><span class="match-odds" style="font-size:0.75rem;">Draw ${formatOdds(match.drawOdds)}</span></div>` : ''}
                        <div class="match-indicators">
                            ${hasMovement ? '<span class="match-indicator movement">üìà Line Move</span>' : ''}
                            ${hasInjury ? '<span class="match-indicator injury">üè• Injury</span>' : ''}
                            ${hasWeather ? '<span class="match-indicator weather">üåßÔ∏è Weather</span>' : ''}
                            ${hasValue ? '<span class="match-indicator value">üíé Value</span>' : ''}
                        </div>
                        ${match.venue ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.25rem;">üìç ${match.venue}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================
        function formatOdds(decimal) {
            if (!decimal || decimal <= 1) return '--';
            return decimal.toFixed(2);
        }

        function formatTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            } catch {
                return '--:--';
            }
        }

        function getLeagueShortName(key, fullName) {
            // First try by key
            const keyNames = {
                'premier-league': 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø EPL',
                'la-liga': 'üá™üá∏ La Liga',
                'bundesliga': 'üá©üá™ Bundesliga',
                'serie-a': 'üáÆüáπ Serie A',
                'ligue-1': 'üá´üá∑ Ligue 1',
                'ucl': 'üèÜ UCL',
                'uel': 'üèÜ UEL',
                'nba': 'üèÄ NBA',
                'nfl': 'üèà NFL',
                'nhl': 'üèí NHL',
                'mlb': '‚öæ MLB',
                'mls': 'üá∫üá∏ MLS'
            };
            
            if (keyNames[key]) return keyNames[key];
            
            // Try to derive from full name
            const name = (fullName || key || '').toLowerCase();
            if (name.includes('premier league')) return 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø EPL';
            if (name.includes('la liga') || name.includes('primera division')) return 'üá™üá∏ La Liga';
            if (name.includes('bundesliga') && !name.includes('2.')) return 'üá©üá™ Bundesliga';
            if (name.includes('serie a') && name.includes('ital')) return 'üáÆüáπ Serie A';
            if (name.includes('ligue 1')) return 'üá´üá∑ Ligue 1';
            if (name.includes('champions league')) return 'üèÜ UCL';
            if (name.includes('europa league')) return 'üèÜ UEL';
            if (name.includes('nba')) return 'üèÄ NBA';
            if (name.includes('nfl')) return 'üèà NFL';
            if (name.includes('nhl')) return 'üèí NHL';
            if (name.includes('mlb')) return '‚öæ MLB';
            if (name.includes('mls')) return 'üá∫üá∏ MLS';
            if (name.includes('eredivisie')) return 'üá≥üá± Eredivisie';
            if (name.includes('league 1') && name.includes('english')) return 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø EFL L1';
            if (name.includes('championship')) return 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Champ';
            if (name.includes('ncaa')) return 'üèà NCAA';
            if (name.includes('cfl')) return 'üá®üá¶ CFL';
            
            // Return truncated name with flag
            const flag = getLeagueFlag(name);
            const shortName = (fullName || key || '').replace(/\s+(League|Football|Soccer|Division)/gi, '').substring(0, 12);
            return `${flag} ${shortName}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('utc-time').textContent = 
                now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC' }) + ' UTC';
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        document.querySelectorAll('.league-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.league-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeLeague = chip.dataset.league;
                plotMatchesOnMap();
                renderMatchGrid();
            });
        });

        document.querySelectorAll('.layer-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                activeLayers[toggle.dataset.layer] = toggle.classList.contains('active');
                plotMatchesOnMap();
                renderMatchGrid();
            });
        });

        // ============================================================================
        // INITIALIZE
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            updateClock();
            setInterval(updateClock, 1000);
            // Use background refresh to avoid blocking UI
            setInterval(refreshDataInBackground, CONFIG.REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
